<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MORF Disposition Pro</title>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Bcrypt for password hashing -->
    <script src="https://cdn.jsdelivr.net/npm/bcryptjs@2.4.3/dist/bcrypt.min.js"></script>
    
    <!-- Chart.js for weather chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Google Fonts - Roboto -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* MORF CI Colors */
            --morf-dark: #2d3748;
            --morf-yellow: #fbbf24;
            --bg-light: #f8f9fa;
            --white: #ffffff;
            --text-dark: #1f2937;
            --text-gray: #6b7280;
            --border: #e5e7eb;
            
            /* Semantic Colors */
            --primary: var(--morf-dark);
            --accent: var(--morf-yellow);
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        body {
            font-family: 'Roboto', 'Helvetica', 'Arial', sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* Login Screen */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--morf-dark) 0%, #1a202c 100%);
            padding: 20px;
        }

        .login-box {
            background: var(--white);
            padding: 48px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 440px;
            position: relative;
        }

        /* MORF Logo Triangle Accent */
        .login-box::before {
            content: '';
            position: absolute;
            top: -1px;
            left: 40px;
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 30px solid var(--accent);
            transform: translateY(-100%);
        }

        .logo-container {
            text-align: center;
            margin-bottom: 32px;
        }

        .logo {
            max-width: 200px;
            height: auto;
        }

        .app-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin-top: 16px;
            letter-spacing: -0.5px;
        }

        .app-subtitle {
            font-size: 14px;
            color: var(--text-gray);
            margin-top: 4px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1a202c;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(45, 55, 72, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        /* Compact button variant */
        .btn-compact {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }

        /* Yellow accent bar */
        .btn-primary::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--accent);
        }

        .error-message {
            background: #fee;
            color: var(--danger);
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Loading State */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Main App (hidden initially) */
        #mainApp {
            display: none;
            min-height: 100vh;
        }

        /* Header */
        .app-header {
            background: #4A5967;
            border-bottom: none;
            padding: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 12px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-shrink: 0;
        }

        /* Header Navigation */
        .header-nav {
            display: flex;
            gap: 0;
            flex: 1;
            justify-content: center;
            margin: 0 48px;
        }

        .header-nav-item {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            background: #5C6A76;
            border: none;
            border-radius: 0;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            white-space: nowrap;
        }

        .header-nav-item:first-child {
            border-radius: 8px 0 0 8px;
        }

        .header-nav-item:last-child {
            border-radius: 0 8px 8px 0;
            border-right: none;
        }

        .header-nav-item:hover {
            background: #6D7984;
            color: white;
        }

        .header-nav-item.active {
            background: white;
            color: #334155;
            font-weight: 600;
        }

        .header-nav-icon {
            display: none;
        }

        .header-nav-item.active .header-nav-icon {
            display: none;
        }

        .header-logo {
            height: 32px;
            width: auto;
        }

        .header-triangle {
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 15px solid var(--accent);
        }

        .header-title {
            font-size: 20px;
            font-weight: 700;
            color: white;
            letter-spacing: -0.5px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
        }

        /* User Avatar */
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--morf-dark) 0%, #1a202c 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .user-avatar:hover {
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .user-avatar::after {
            content: '';
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            background: var(--accent);
            border-radius: 50%;
            border: 2px solid white;
        }

        /* Dropdown Menu */
        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 12px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            min-width: 280px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s;
            z-index: 1000;
        }

        .user-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .dropdown-user-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .dropdown-user-role {
            font-size: 13px;
            color: var(--text-gray);
            display: inline-block;
            padding: 4px 12px;
            background: var(--bg-light);
            border-radius: 12px;
        }

        .dropdown-menu {
            padding: 8px;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            color: var(--text-dark);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
            font-family: inherit;
        }

        .dropdown-item:hover {
            background: var(--bg-light);
        }

        .dropdown-item.danger {
            color: var(--danger);
        }

        .dropdown-item.danger:hover {
            background: #fee;
        }

        .dropdown-icon {
            font-size: 18px;
            width: 20px;
            text-align: center;
        }

        /* Content Area */
        .app-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 32px;
        }

        /* Navigation */
        .nav-container {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
            background: var(--white);
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .nav-item {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-gray);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .nav-item:hover {
            background: var(--bg-light);
            color: var(--text-dark);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
            position: relative;
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20%;
            right: 20%;
            height: 3px;
            background: var(--accent);
        }

        .nav-icon {
            font-size: 20px;
        }

        /* Content Views */
        .content-view {
            display: none;
        }

        .content-view.active {
            display: block;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-top: 15px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin: 0;
        }

        .page-subtitle {
            font-size: 16px;
            color: var(--text-gray);
            margin: 4px 0 0 0;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            display: flex;
            gap: 20px;
            align-items: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 64px;
            height: 64px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .stat-content {
            flex: 1;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-gray);
            margin-top: 4px;
        }

        /* Welcome Card */
        .welcome-card {
            background: var(--white);
            border-radius: 12px;
            padding: 48px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .welcome-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            background: linear-gradient(135deg, var(--morf-dark) 0%, #1a202c 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .welcome-icon::after {
            content: '';
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 25px solid var(--accent);
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 12px;
        }

        .welcome-text {
            font-size: 16px;
            color: var(--text-gray);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Coming Soon */
        .coming-soon {
            background: var(--white);
            border-radius: 12px;
            padding: 80px 40px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .coming-soon h3 {
            color: var(--text-gray);
            font-weight: 500;
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            display: flex;
            align-items: center;
            background: var(--white);
            padding: 0 16px;
            border-radius: 8px;
            border: 2px solid var(--border);
            transition: all 0.2s;
        }

        .search-box:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
        }

        .search-box input {
            flex: 1;
            border: none;
            outline: none;
            padding: 12px 0;
            font-size: 14px;
            font-family: inherit;
        }

        .filter-select {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--white);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
        }

        .btn-filter-reset {
            padding: 12px 20px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            background: var(--white);
            color: var(--text-gray);
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-filter-reset:hover {
            border-color: var(--text-gray);
            color: var(--text-dark);
        }

        /* Data Card */
        .data-card {
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .data-card.calendar-card {
            overflow: visible;
        }

        /* Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: var(--bg-light);
        }

        .data-table th {
            padding: 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            padding: 16px;
            border-top: 1px solid var(--border);
            font-size: 14px;
        }

        .data-table tr:hover {
            background: var(--bg-light);
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        .badge-ec {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-ma {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-vw {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-zh {
            background: #e0e7ff;
            color: #3730a3;
        }

        /* Action Buttons */
        .btn-icon {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            background: transparent;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 16px;
        }

        .btn-icon:hover {
            background: var(--bg-light);
        }

        .btn-icon.danger:hover {
            background: #fee;
            color: var(--danger);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-gray);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Admin Panel */
        .role-card {
            background: var(--white);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            transition: all 0.2s;
        }

        .role-card:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .role-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border);
        }

        .role-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .role-badge-large {
            padding: 6px 16px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 600;
        }

        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .permission-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-light);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .permission-item:hover {
            background: #e5e7eb;
        }

        .permission-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .permission-label {
            flex: 1;
            font-size: 14px;
            color: var(--text-dark);
            cursor: pointer;
            user-select: none;
        }

        .permission-icon {
            font-size: 18px;
        }

        .save-indicator {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--success);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            z-index: 10000;
        }

        .save-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Stellvertreter Checkboxes */
        .stv-checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .stv-checkbox-item:hover {
            border-color: var(--accent);
            background: #fffbeb;
        }

        .stv-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .stv-checkbox-label {
            flex: 1;
            font-size: 14px;
            color: var(--text-dark);
            cursor: pointer;
        }

        .stv-role-badge {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        /* Calendar Styles */
        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding: 16px 24px;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .calendar-month-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin: 0;
        }

        .btn-calendar-nav {
            padding: 10px 20px;
            background: var(--bg-light);
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-calendar-nav:hover {
            background: var(--border);
            border-color: var(--accent);
        }

        .filter-label {
            padding: 6px 8px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            user-select: none;
            border-radius: 4px;
            transition: all 0.2s;
            display: block;
        }

        .filter-label:hover {
            background: #fffbeb;
        }

        .filter-dropdown {
            display: none;
            position: absolute;
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            min-width: 120px;
            padding: 6px;
        }

        .filter-dropdown.show {
            display: block;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 3px 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 400;
            border-radius: 3px;
            transition: all 0.15s;
            user-select: none;
        }

        .filter-option:hover {
            background: #f3f4f6;
        }

        .filter-option input[type="checkbox"] {
            cursor: pointer;
            width: 13px;
            height: 13px;
            accent-color: #6b7280;
            border: 1px solid #d1d5db;
        }

        .filter-option:first-child {
            font-weight: 500;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 2px;
            padding-bottom: 6px;
        }

        .dropdown-container {
            position: relative;
        }

        .abwesenheit-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 200px;
            overflow: hidden;
        }

        .abwesenheit-dropdown.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            transition: all 0.2s;
            border-bottom: 1px solid var(--border);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: var(--bg-light);
        }

        .filter-dropdown {
            display: none;
            position: absolute;
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            min-width: 120px;
            padding: 6px;
        }

        .absence-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 24px;
            padding: 16px;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-dark);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        /* Calendar Matrix */
        .calendar-matrix {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .calendar-matrix th {
            background: var(--bg-light);
            padding: 6px 4px;
            text-align: center;
            font-weight: 600;
            border: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 10px;
        }

        .calendar-matrix th:first-child {
            text-align: left;
            padding-left: 12px;
            min-width: 140px;
            position: sticky;
            left: 0;
            z-index: 11;
            background: var(--bg-light);
        }

        .calendar-matrix th:nth-child(2) {
            position: sticky;
            left: 140px;
            z-index: 11;
            background: var(--bg-light);
        }

        .calendar-matrix th:nth-child(3) {
            position: sticky;
            left: 200px;
            z-index: 11;
            background: var(--bg-light);
        }

        .calendar-matrix th.today-header {
            background: white;
            color: var(--primary);
            font-weight: 700;
        }

        .calendar-matrix td {
            padding: 0;
            border: 1px solid var(--border);
            text-align: center;
            height: 28px;
        }

        .calendar-matrix td:first-child {
            text-align: left;
            padding-left: 12px;
            font-weight: 500;
            background: var(--bg-light);
            position: sticky;
            left: 0;
            z-index: 5;
            font-size: 12px;
        }

        .calendar-matrix td:nth-child(2) {
            font-size: 11px;
            font-weight: 500;
            background: var(--bg-light);
            position: sticky;
            left: 140px;
            z-index: 5;
        }

        .calendar-matrix td:nth-child(3) {
            font-size: 11px;
            font-weight: 500;
            background: var(--bg-light);
            position: sticky;
            left: 200px;
            z-index: 5;
        }

        .calendar-day-cell {
            cursor: pointer;
            transition: all 0.2s;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .calendar-day-cell:hover {
            background: rgba(251, 191, 36, 0.1);
        }

        .calendar-day-cell.weekend {
            background: #f9fafb;
        }

        .calendar-day-cell.today {
            /* No special styling for cell */
        }

        .absence-badge {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 10px;
        }

        .absence-fe { background: #DBEAFE; color: #1e40af; } /* Hellblau */
        .absence-ko { background: #DCFCE7; color: #166534; } /* Hellgr√ºn */
        .absence-bf { background: #FEF3C7; color: #92400e; } /* Hellgelb */
        .absence-kr { background: #FECACA; color: #991b1b; } /* Hellrot */
        .absence-uf { background: #FED7AA; color: #9a3412; } /* Hellorange */
        .absence-ft { background: #E9D5FF; color: #6b21a8; } /* Helllila */
        .absence-arb { background: #D1FAE5; color: #065f46; } /* Hellgr√ºn (dunkel) */

        /* Diagonal split for BF/FT + ARB */
        .absence-badge-split {
            width: 100%;
            height: 100%;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        .absence-split-left {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 10px;
            clip-path: polygon(0 0, 100% 0, 0 100%);
        }

        .absence-split-right {
            position: absolute;
            width: 100%;
            height: 100%;
            clip-path: polygon(100% 0, 100% 100%, 0 100%);
        }

        /* White diagonal divider line */
        .absence-badge-split::after {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            background: linear-gradient(to bottom right, transparent 49%, white 49%, white 51%, transparent 51%);
            pointer-events: none;
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        /* ============================================ */
        /* RESPONSIVE DESIGN - MEDIA QUERIES */
        /* ============================================ */

        /* Large Desktop (1920px+) */
        @media (min-width: 1920px) {
            .content {
                max-width: 1800px;
                margin: 0 auto;
            }
        }

        /* Standard Desktop (1200px - 1920px) */
        @media (max-width: 1920px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Small Desktop / Large Tablet (900px - 1200px) */
        @media (max-width: 1200px) {
            .header-title {
                font-size: 18px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header-nav-item {
                padding: 8px 16px;
                font-size: 12px;
            }
            
            /* Weather widgets - 2 columns */
            .weather-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }

        /* Tablet (768px - 900px) */
        @media (max-width: 900px) {
            .sidebar {
                width: 200px;
            }
            
            .content {
                margin-left: 200px;
                padding: 16px;
            }
            
            .header {
                margin-left: 200px;
            }
            
            .page-title {
                font-size: 24px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .data-card {
                padding: 16px;
            }
            
            /* Modals smaller */
            .modal-content {
                width: 90%;
                max-width: 600px;
            }
        }

        /* Mobile Landscape / Small Tablet (600px - 768px) */
        @media (max-width: 768px) {
            .header-nav {
                flex-wrap: wrap;
            }
            
            .header-nav-item {
                padding: 6px 12px;
                font-size: 11px;
            }
            
            /* Weather widgets - 1 column */
            .weather-grid {
                grid-template-columns: 1fr !important;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            /* Tables scroll */
            .data-card {
                overflow-x: auto;
            }
        }

        /* Mobile Portrait (up to 600px) */
        @media (max-width: 600px) {
            /* Collapse sidebar */
            .sidebar {
                width: 60px;
            }
            
            .sidebar-item span {
                display: none;
            }
            
            .content {
                margin-left: 60px;
                padding: 12px;
            }
            
            .header {
                margin-left: 60px;
                padding: 12px;
            }
            
            .header-title {
                font-size: 14px;
            }
            
            .header-nav {
                gap: 4px;
            }
            
            .header-nav-item {
                padding: 6px 8px;
                font-size: 10px;
            }
            
            .page-title {
                font-size: 20px;
            }
            
            .page-subtitle {
                font-size: 12px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .stat-card {
                padding: 12px;
            }
            
            .stat-value {
                font-size: 24px;
            }
            
            /* Modal full width on mobile */
            .modal-content {
                width: 95%;
                margin: 10px auto;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* Buttons stack */
            .modal-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .modal-actions button {
                width: 100%;
            }
            
            /* Form groups full width */
            .form-row {
                flex-direction: column;
            }
            
            .form-row .form-group {
                width: 100%;
            }
            
            /* Tables responsive */
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 6px 4px;
            }
        }

        /* Very Small Mobile (up to 400px) */
        @media (max-width: 400px) {
            .header-brand {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
            
            .header-title {
                font-size: 12px;
            }
            
            .page-title {
                font-size: 18px;
            }
            
            .stat-card {
                padding: 10px;
            }
            
            .stat-icon {
                width: 40px;
                height: 40px;
            }
            
            table {
                font-size: 10px;
            }
        }

        /* Landscape orientation fixes */
        @media (max-height: 600px) and (orientation: landscape) {
            .modal-content {
                max-height: 95vh;
                overflow-y: auto;
            }
            
            .header {
                padding: 8px 16px;
            }
        }

        /* Print styles */
        @media print {
            .sidebar,
            .header-nav,
            .btn,
            .modal {
                display: none !important;
            }
            
            .content {
                margin-left: 0;
            }
            
            .header {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="logo-container">
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" 
                     alt="MORF Logo" 
                     class="logo"
                     style="display: none;">
                <div class="app-title">MORF Disposition</div>
                <div class="app-subtitle">Professional Edition</div>
            </div>

            <div id="errorMessage" class="error-message"></div>

            <form id="loginForm" onsubmit="handleLogin(event); return false;">
                <div class="form-group">
                    <label for="username">Benutzername</label>
                    <input 
                        type="text" 
                        id="username" 
                        name="username" 
                        required 
                        autocomplete="username"
                        placeholder="Ihr Benutzername">
                </div>

                <div class="form-group">
                    <label for="password">Passwort</label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        required 
                        autocomplete="current-password"
                        placeholder="Ihr Passwort">
                </div>

                <button type="submit" class="btn btn-primary">
                    Anmelden
                </button>
            </form>

            <div id="loginLoading" class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 16px; color: var(--text-gray);">Anmeldung l√§uft...</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp">
        <header class="app-header">
            <div class="header-content">
                <div class="header-left">
                    <div class="header-triangle"></div>
                    <div class="header-title">MORF Disposition Pro</div>
                </div>
                
                <!-- Navigation in Header -->
                <div class="header-nav">
                    <button class="header-nav-item active" onclick="showView('dashboard')">
                        <span class="header-nav-icon">üìä</span>
                        <span>Dashboard</span>
                    </button>
                    <button class="header-nav-item" onclick="showView('personal')" data-permission="canViewPersonal">
                        <span class="header-nav-icon">üë•</span>
                        <span>Personal</span>
                    </button>
                    <button class="header-nav-item" onclick="showView('kalender')" data-permission="canViewCalendar">
                        <span class="header-nav-icon">üìÖ</span>
                        <span>Kalender</span>
                    </button>
                    <button class="header-nav-item" onclick="showView('auftraege')" data-permission="canViewAuftraege">
                        <span class="header-nav-icon">üìã</span>
                        <span>Auftr√§ge</span>
                    </button>
                    <button class="header-nav-item" onclick="showView('tagesprogramm')" data-permission="canViewTagesprogramm">
                        <span class="header-nav-icon">üóìÔ∏è</span>
                        <span>Tagesprogramm</span>
                    </button>
                </div>
                
                <div class="header-right">
                    <div class="user-avatar" onclick="toggleUserMenu()" id="userAvatar">
                        MF
                    </div>
                    <div class="user-dropdown" id="userDropdown">
                        <div class="dropdown-header">
                            <div class="dropdown-user-name" id="dropdownUserName">Manuel Fuchs</div>
                            <div class="dropdown-user-role" id="dropdownUserRole">AD - Administrator</div>
                        </div>
                        <div class="dropdown-menu">
                            <button class="dropdown-item" onclick="openMeinProfil()">
                                <span class="dropdown-icon">üë§</span>
                                <span>Mein Profil</span>
                            </button>
                            <button class="dropdown-item" onclick="openSettings()">
                                <span class="dropdown-icon">‚öôÔ∏è</span>
                                <span>Kontoeinstellungen</span>
                            </button>
                            <button class="dropdown-item" onclick="openPasswordChange()">
                                <span class="dropdown-icon">üîí</span>
                                <span>Passwort √§ndern</span>
                            </button>
                            <button class="dropdown-item" id="menuBerechtigungen" onclick="openBerechtigungen()" style="display: none;">
                                <span class="dropdown-icon">üë•</span>
                                <span>Berechtigungen</span>
                            </button>
                            <div style="height: 8px;"></div>
                            <button class="dropdown-item danger" onclick="logout()">
                                <span class="dropdown-icon">üö™</span>
                                <span>Abmelden</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="app-content">
            <!-- Dashboard View -->
            <div id="dashboardView" class="content-view active">
                <div class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                    <p class="page-subtitle">√úbersicht √ºber Ihr Dispositionssystem</p>
                </div>

                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                            <span style="font-size: 24px;">üë•</span>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="statMitarbeiter">0</div>
                            <div class="stat-label">Mitarbeiter</div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            <span style="font-size: 24px;">üìã</span>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="statAuftraege">0</div>
                            <div class="stat-label">Offene Auftr√§ge</div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            <span style="font-size: 24px;">üìÖ</span>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="statAbwesenheiten">0</div>
                            <div class="stat-label">Abwesenheiten</div>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, var(--morf-dark) 0%, #1a202c 100%);">
                            <span style="font-size: 24px;">‚ö°</span>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" style="color: var(--accent);">LIVE</div>
                            <div class="stat-label">Multi-User Aktiv</div>
                        </div>
                    </div>
                </div>

                <!-- Weather Widgets Grid -->
                <div class="weather-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <!-- Oberglatt -->
                    <div class="data-card" style="min-height: 250px;">
                        <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">
                            üå§Ô∏è Oberglatt
                        </h3>
                        <div id="weatherLoadingOberglatt" style="text-align: center; padding: 20px; color: var(--text-gray); font-size: 13px;">
                            Lade...
                        </div>
                        <div id="weatherWidgetOberglatt" style="display: none;"></div>
                    </div>

                    <!-- Schaffhausen -->
                    <div class="data-card" style="min-height: 250px;">
                        <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">
                            üå§Ô∏è Schaffhausen
                        </h3>
                        <div id="weatherLoadingSchaffhausen" style="text-align: center; padding: 20px; color: var(--text-gray); font-size: 13px;">
                            Lade...
                        </div>
                        <div id="weatherWidgetSchaffhausen" style="display: none;"></div>
                    </div>

                    <!-- Meilen -->
                    <div class="data-card" style="min-height: 250px;">
                        <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">
                            üå§Ô∏è Meilen
                        </h3>
                        <div id="weatherLoadingMeilen" style="text-align: center; padding: 20px; color: var(--text-gray); font-size: 13px;">
                            Lade...
                        </div>
                        <div id="weatherWidgetMeilen" style="display: none;"></div>
                    </div>

                    <!-- Dietikon -->
                    <div class="data-card" style="min-height: 250px;">
                        <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600;">
                            üå§Ô∏è Dietikon
                        </h3>
                        <div id="weatherLoadingDietikon" style="text-align: center; padding: 20px; color: var(--text-gray); font-size: 13px;">
                            Lade...
                        </div>
                        <div id="weatherWidgetDietikon" style="display: none;"></div>
                    </div>
                </div>

                <!-- Welcome Card -->
                <div class="welcome-card">
                    <div class="welcome-icon"></div>
                    <h2 class="welcome-title">Willkommen zur√ºck! üëã</h2>
                    <p class="welcome-text">
                        Das neue MORF Disposition Pro System ist bereit f√ºr den Multi-User Betrieb.
                        Alle Daten werden in Echtzeit synchronisiert.
                    </p>
                </div>
            </div>

            <!-- Personal View -->
            <div id="personalView" class="content-view">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Personal</h1>
                    </div>
                    <button class="btn btn-primary btn-compact" id="btnAddMitarbeiter" onclick="openAddMitarbeiterDialog()" style="display: none;">
                        <span style="font-size: 16px; margin-right: 4px;">+</span>
                        Neue/-r Mitarbeiter/-in
                    </button>
                </div>

                <!-- Filters -->
                <div class="filter-bar">
                    <div class="search-box">
                        <span style="color: var(--text-gray); margin-right: 8px;">üîç</span>
                        <input 
                            type="text" 
                            id="searchMitarbeiter" 
                            placeholder="Suche nach Name oder Personal-ID..."
                            oninput="filterMitarbeiter()">
                    </div>
                    
                    <select id="filterFunktion" onchange="filterMitarbeiter()" class="filter-select">
                        <option value="">Alle Funktionen</option>
                        <option value="GL">GL - Gesch√§ftsleitung</option>
                        <option value="FL">FL - Filialleiter</option>
                        <option value="DI">DI - Disponent</option>
                        <option value="EC">EC - Equipenchef</option>
                        <option value="PL">PL - Projektleiter</option>
                        <option value="TKB">TKB - Technischer Kundenberater</option>
                        <option value="MA">MA - Markierer</option>
                        <option value="WS">WS - Werkstatt</option>
                        <option value="BO">BO - Backoffice</option>
                    </select>

                    <select id="filterFiliale" onchange="filterMitarbeiter()" class="filter-select">
                        <option value="">Alle Filialen</option>
                        <option value="VW">Verwaltung</option>
                        <option value="AG">Aargau</option>
                        <option value="BO">Backoffice</option>
                        <option value="GL">Glarus</option>
                        <option value="GR">Graub√ºnden</option>
                        <option value="SG">St. Gallen</option>
                        <option value="ZH">Z√ºrich</option>
                        <option value="ZS">Zentralschweiz</option>
                        <option value="WS">Werkstatt</option>
                    </select>

                    <button class="btn-filter-reset" onclick="resetFilters()">
                        Zur√ºcksetzen
                    </button>
                </div>

                <!-- Mitarbeiter Table -->
                <div class="data-card">
                    <div id="mitarbeiterTableContainer"></div>
                </div>
            </div>

            <!-- Kalender View -->
            <div id="kalenderView" class="content-view">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Kalender & Abwesenheiten</h1>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary btn-compact" onclick="kalenderHeute()">
                            Heute
                        </button>
                        <div class="dropdown-container" id="btnAddAbwesenheit" style="display: none; position: relative;">
                            <button class="btn btn-primary btn-compact" onclick="toggleAbwesenheitDropdown(event)">
                                <span style="font-size: 16px; margin-right: 4px;">+</span>
                                Neue Abwesenheit
                                <span style="margin-left: 4px;">‚ñº</span>
                            </button>
                            <div class="abwesenheit-dropdown" id="abwesenheitDropdown">
                                <div class="dropdown-item" onclick="openAbwesenheitDialog(); closeAbwesenheitDropdown();">
                                    <span style="font-size: 16px; margin-right: 8px;">üë§</span>
                                    Einzelne Abwesenheit
                                </div>
                                <div class="dropdown-item" id="dropdownBetriebsferien" onclick="openBetriebsferienDialog(); closeAbwesenheitDropdown();" style="display: none;">
                                    <span style="font-size: 16px; margin-right: 8px;">üè¢</span>
                                    Betriebsferien
                                </div>
                                <div class="dropdown-item" id="dropdownFeiertage" onclick="openFeiertagDialog(); closeAbwesenheitDropdown();" style="display: none;">
                                    <span style="font-size: 16px; margin-right: 8px;">üéâ</span>
                                    Feiertage
                                </div>
                                <div class="dropdown-item" id="dropdownBfFtLoeschen" onclick="openLoeschenDialog(); closeAbwesenheitDropdown();" style="border-top: 1px solid var(--border); color: var(--danger); display: none;">
                                    <span style="font-size: 16px; margin-right: 8px;">üóëÔ∏è</span>
                                    BF/FT verwalten
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calendar Navigation -->
                <div class="calendar-nav">
                    <button class="btn-calendar-nav" onclick="kalenderPrevMonth()">‚Äπ Vorheriger Monat</button>
                    <h2 id="kalenderMonthTitle" class="calendar-month-title">Februar 2026</h2>
                    <button class="btn-calendar-nav" onclick="kalenderNextMonth()">N√§chster Monat ‚Ä∫</button>
                </div>

                <!-- Legend -->
                <div class="absence-legend">
                    <div class="legend-item"><span class="legend-color" style="background: #DBEAFE;"></span> FE - Ferien</div>
                    <div class="legend-item"><span class="legend-color" style="background: #DCFCE7;"></span> KO - Kompensation</div>
                    <div class="legend-item"><span class="legend-color" style="background: #FEF3C7;"></span> BF - Betriebsferien</div>
                    <div class="legend-item"><span class="legend-color" style="background: #FECACA;"></span> KR - Krankheit</div>
                    <div class="legend-item"><span class="legend-color" style="background: #FED7AA;"></span> UF - Unfall</div>
                    <div class="legend-item"><span class="legend-color" style="background: #E9D5FF;"></span> FT - Feiertag</div>
                </div>

                <!-- Calendar Matrix -->
                <div class="data-card calendar-card" style="position: relative;">
                    <div id="kalenderMatrixContainer" style="overflow-x: auto; overflow-y: visible;">
                        <!-- Will be loaded dynamically -->
                    </div>
                    
                    <!-- Filter Dropdowns (outside table, will be positioned absolutely) -->
                    <div id="filterDropdownContainer">
                        <div id="funktionFilter" class="filter-dropdown">
                            <!-- Will be populated dynamically -->
                        </div>
                        <div id="filialeFilter" class="filter-dropdown">
                            <!-- Will be populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>

            <div id="auftraegeView" class="content-view">
                <div class="page-header">
                    <h1 class="page-title">Auftr√§ge</h1>
                </div>
                <div class="coming-soon">
                    <div style="font-size: 64px; margin-bottom: 16px;">üìã</div>
                    <h3>Wird gebaut...</h3>
                </div>
            </div>

            <div id="tagesprogrammView" class="content-view">
                <div class="page-header">
                    <h1 class="page-title">Tagesprogramm</h1>
                </div>
                <div class="coming-soon">
                    <div style="font-size: 64px; margin-bottom: 16px;">üóìÔ∏è</div>
                    <h3>Wird gebaut...</h3>
                </div>
            </div>

            <!-- Admin View -->
            <div id="adminView" class="content-view">
                <div class="page-header">
                    <div>
                        <h1 class="page-title">Administration</h1>
                        <p class="page-subtitle">Rollen & Berechtigungen verwalten</p>
                    </div>
                </div>

                <div class="data-card">
                    <div style="padding: 24px;">
                        <h3 style="margin: 0 0 8px 0; color: var(--primary);">Rollenberechtigungen</h3>
                        <p style="color: var(--text-gray); font-size: 14px; margin: 0 0 24px 0;">
                            Definieren Sie welche Rolle welche Bereiche sehen und bearbeiten darf.
                            <strong>√Ñnderungen werden sofort wirksam.</strong>
                        </p>

                        <div id="rolesPermissionsContainer">
                            <!-- Will be loaded dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://vszwoyykoxpsbbjcsxbj.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_lFujU57HDKGHOTh3zVrabA_uxurhbav';
        let supabaseClient = null;
        let currentUser = null;

        // Initialize Supabase
        document.addEventListener('DOMContentLoaded', () => {
            if (window.supabase) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                    auth: {
                        persistSession: false
                    },
                    global: {
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    }
                });
                console.log('‚úÖ MORF Disposition Pro - Supabase connected');
            } else {
                showError('Fehler beim Laden der Anwendung. Bitte Seite neu laden.');
            }

            // Check for existing session
            checkSession();
        });

        // ============================================
        // LOGIN SYSTEM
        // ============================================
        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            // Hide error
            document.getElementById('errorMessage').classList.remove('show');
            
            // Show loading
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('loginLoading').style.display = 'block';

            try {
                // Query user from database
                const { data, error } = await supabaseClient
                    .from('system_users')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password)
                    .eq('active', true)
                    .single();

                if (error || !data) {
                    throw new Error('Ung√ºltige Anmeldedaten');
                }

                // Get permissions
                const { data: permData } = await supabaseClient
                    .from('role_permissions')
                    .select('permissions')
                    .eq('role', data.role)
                    .single();

                // Check if user is stellvertreter
                let isStellvertreter = false;
                if (data.role !== 'admin') {
                    const { data: stvData } = await supabaseClient
                        .from('admin_stellvertreter')
                        .select('id')
                        .eq('stellvertreter_user_id', data.id)
                        .single();
                    
                    isStellvertreter = !!stvData;
                }

                // Set current user
                currentUser = {
                    id: data.id,
                    username: data.username,
                    name: data.name,
                    role: data.role,
                    permissions: permData?.permissions || {},
                    isStellvertreter: isStellvertreter
                };

                // Save session
                sessionStorage.setItem('morfUser', JSON.stringify(currentUser));

                console.log('‚úÖ Login successful:', currentUser.name, isStellvertreter ? '(Stellvertreter)' : '');

                // Show main app
                showMainApp();

            } catch (error) {
                console.error('Login error:', error);
                showError(error.message || 'Anmeldung fehlgeschlagen');
                
                // Reset form
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('loginLoading').style.display = 'none';
                document.getElementById('password').value = '';
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';

            // Update user info
            const initials = getInitials(currentUser.name);
            document.getElementById('userAvatar').textContent = initials;
            document.getElementById('dropdownUserName').textContent = currentUser.name;
            
            // Load avatar foto
            updateHeaderAvatar();
            
            let roleDisplay = getRoleDisplayName(currentUser.role);
            if (currentUser.isStellvertreter) {
                roleDisplay += ' (Admin-Stellvertreter)';
            }
            document.getElementById('dropdownUserRole').textContent = roleDisplay;

            // Show Berechtigungen menu item for admins and stellvertreter
            if (isAdmin()) {
                document.getElementById('menuBerechtigungen').style.display = 'flex';
            }

            // Update navigation based on permissions
            updateNavigationVisibility();

            // Load dashboard data
            loadDashboardData();
        }

        function getInitials(name) {
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const avatar = document.getElementById('userAvatar');
            const dropdown = document.getElementById('userDropdown');
            
            if (avatar && dropdown && !avatar.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        function openSettings() {
            alert('Kontoeinstellungen - wird noch gebaut! üöß');
            document.getElementById('userDropdown').classList.remove('show');
        }

        function openPasswordChange() {
            alert('Passwort √§ndern - wird noch gebaut! üöß');
            document.getElementById('userDropdown').classList.remove('show');
        }

        function getRoleDisplayName(role) {
            const roles = {
                'admin': 'AD - Administrator',
                'disponent': 'D - Disponent',
                'tkb': 'TKB - Technischer Kundenberater',
                'geschaeftsleitung': 'GL - Gesch√§ftsleitung'
            };
            return roles[role] || role;
        }

        function getRoleBadgeColor(role) {
            const colors = {
                'admin': '#ef4444',           // Rot
                'disponent': '#3b82f6',       // Blau
                'tkb': '#10b981',             // Gr√ºn
                'geschaeftsleitung': '#f59e0b' // Orange
            };
            return colors[role] || '#6b7280';
        }

        function logout() {
            document.getElementById('userDropdown').classList.remove('show');
            
            currentUser = null;
            sessionStorage.removeItem('morfUser');
            
            // Hide main app
            document.getElementById('mainApp').style.display = 'none';
            
            // Show login screen
            document.getElementById('loginScreen').style.display = 'flex';
            
            // Reset login form
            document.getElementById('loginForm').reset();
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('loginLoading').style.display = 'none';
            document.getElementById('errorMessage').classList.remove('show');
            
            console.log('‚úÖ Logged out');
        }

        // Mein Profil Functions (for local file:// testing)
        async function openMeinProfil() {
            document.getElementById('userDropdown').classList.remove('show');
            
            try {
                const { data: mitarbeiter } = await supabaseClient
                    .from('mitarbeiter')
                    .select('id, foto')
                    .ilike('vorname', currentUser.name.split(' ')[0])
                    .ilike('nachname', currentUser.name.split(' ').slice(1).join(' '))
                    .single();
                
                currentUser.mitarbeiterId = mitarbeiter?.id;
                
                const preview = document.getElementById('profilFotoPreview');
                if (mitarbeiter?.foto) {
                    preview.innerHTML = `<img src="${mitarbeiter.foto}" style="width: 100%; height: 100%; object-fit: cover;">`;
                    document.getElementById('btnRemoveFoto').style.display = 'inline-block';
                } else {
                    preview.textContent = getInitials(currentUser.name);
                    preview.style.background = 'var(--primary)';
                    document.getElementById('btnRemoveFoto').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading foto:', error);
                alert('‚ö†Ô∏è Kein Mitarbeiter-Eintrag gefunden f√ºr: ' + currentUser.name);
            }
            
            document.getElementById('meinProfilDialog').classList.add('show');
        }

        function closeMeinProfil() {
            document.getElementById('meinProfilDialog').classList.remove('show');
        }

        async function updateHeaderAvatar() {
            try {
                const { data: mitarbeiter } = await supabaseClient
                    .from('mitarbeiter')
                    .select('foto')
                    .ilike('vorname', currentUser.name.split(' ')[0])
                    .ilike('nachname', currentUser.name.split(' ').slice(1).join(' '))
                    .single();
                
                const avatar = document.getElementById('userAvatar');
                if (mitarbeiter?.foto) {
                    avatar.innerHTML = `<img src="${mitarbeiter.foto}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                } else {
                    avatar.textContent = getInitials(currentUser.name);
                    avatar.style.background = '#4f46e5';
                }
            } catch (error) {
                console.error('Error updating avatar:', error);
            }
        }

        function checkSession() {
            const savedUser = sessionStorage.getItem('morfUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    console.log('‚úÖ Session restored:', currentUser.name);
                    showMainApp();
                } catch (e) {
                    sessionStorage.removeItem('morfUser');
                }
            }
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function showView(viewName) {
            // Check permissions
            if (viewName === 'personal' && !canViewPersonal()) {
                alert('‚õî Keine Berechtigung f√ºr Personal-Ansicht');
                return;
            }
            if (viewName === 'kalender' && !canViewCalendar()) {
                alert('‚õî Keine Berechtigung f√ºr Kalender-Ansicht');
                return;
            }
            if (viewName === 'auftraege' && !canViewAuftraege()) {
                alert('‚õî Keine Berechtigung f√ºr Auftrags-Ansicht');
                return;
            }
            if (viewName === 'tagesprogramm' && !canViewTagesprogramm()) {
                alert('‚õî Keine Berechtigung f√ºr Tagesprogramm');
                return;
            }

            // Hide all views
            document.querySelectorAll('.content-view').forEach(v => {
                v.classList.remove('active');
            });

            // Hide all nav items
            document.querySelectorAll('.header-nav-item').forEach(n => {
                n.classList.remove('active');
            });

            // Show selected view
            document.getElementById(viewName + 'View').classList.add('active');
            
            // Mark nav item as active
            event.target.closest('.header-nav-item').classList.add('active');

            // Load data for view
            if (viewName === 'personal') {
                loadMitarbeiter();
            }
            if (viewName === 'admin') {
                loadAdminPanel();
            }
            if (viewName === 'kalender') {
                loadKalender();
            }

            console.log('üìÑ Switched to:', viewName);
        }

        // ============================================
        // KALENDER & ABWESENHEITEN
        // ============================================
        let currentKalenderMonth = new Date();
        let selectedFunktionen = ['EC', 'MA', 'DP', 'TKB', 'FL', 'VW', 'BO']; // All selected by default
        let selectedFilialen = ['AG', 'BO', 'GL', 'GR', 'SG', 'VW', 'ZH', 'ZS']; // All selected by default
        let openDropdownId = null; // Track which dropdown is open
        let allAbwesenheiten = [];

        async function loadKalender() {
            // Reset filters to default (all selected)
            selectedFunktionen = ['EC', 'MA', 'DP', 'TKB', 'FL', 'VW', 'BO'];
            selectedFilialen = ['AG', 'BO', 'GL', 'GR', 'SG', 'VW', 'ZH', 'ZS'];
            
            try {
                // Load mitarbeiter if not loaded yet
                if (allMitarbeiter.length === 0) {
                    const { data: mitarbeiterData } = await supabaseClient
                        .from('mitarbeiter')
                        .select('*')
                        .order('nachname');
                    
                    allMitarbeiter = mitarbeiterData || [];
                }

                // Load absences
                const { data, error } = await supabaseClient
                    .from('abwesenheits_perioden')
                    .select('*')
                    .order('von');

                if (error) throw error;

                allAbwesenheiten = data || [];
                renderKalenderMatrix();

                // Show add button based on permissions
                const addBtn = document.getElementById('btnAddAbwesenheit');
                if (addBtn) {
                    addBtn.style.display = canEditCalendar() ? 'flex' : 'none';
                }

                console.log('‚úÖ Kalender loaded:', allAbwesenheiten.length, 'absences,', allMitarbeiter.length, 'mitarbeiter');
            } catch (error) {
                console.error('Error loading kalender:', error);
            }
        }

        function kalenderHeute() {
            currentKalenderMonth = new Date();
            renderKalenderMatrix();
        }

        function kalenderPrevMonth() {
            currentKalenderMonth.setMonth(currentKalenderMonth.getMonth() - 1);
            renderKalenderMatrix();
        }

        function kalenderNextMonth() {
            currentKalenderMonth.setMonth(currentKalenderMonth.getMonth() + 1);
            renderKalenderMatrix();
        }

        function filterKalender() {
            renderKalenderMatrix();
        }

        function positionAndShowDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;
            
            // Find the header element
            const headerId = dropdownId === 'funktionFilter' ? 'funktionHeader' : 'filialeHeader';
            const header = document.getElementById(headerId);
            if (!header) return;
            
            // Get positions
            const headerRect = header.getBoundingClientRect();
            const container = header.closest('.data-card');
            const containerRect = container.getBoundingClientRect();
            
            // Position dropdown below header, relative to container
            dropdown.style.top = (headerRect.bottom - containerRect.top + 4) + 'px';
            dropdown.style.left = (headerRect.left - containerRect.left) + 'px';
            dropdown.classList.add('show');
        }

        function toggleFilterDropdown(id, event) {
            if (openDropdownId === id) {
                // Clicking same header - close it
                openDropdownId = null;
                document.querySelectorAll('.filter-dropdown').forEach(d => d.classList.remove('show'));
            } else {
                // Opening new dropdown
                openDropdownId = id;
                
                // Close all others
                document.querySelectorAll('.filter-dropdown').forEach(d => {
                    if (d.id !== id) {
                        d.classList.remove('show');
                    }
                });
                
                // Position and show this one
                positionAndShowDropdown(id);
            }
        }

        function updateFunktionFilter() {
            // Update global state from checkboxes
            selectedFunktionen = Array.from(document.querySelectorAll('.funktion-checkbox:checked')).map(cb => cb.value);
            filterKalender();
            // Don't close dropdown - keep it open for more selections
        }

        function updateFilialeFilter() {
            // Update global state from checkboxes
            selectedFilialen = Array.from(document.querySelectorAll('.filiale-checkbox:checked')).map(cb => cb.value);
            filterKalender();
            // Don't close dropdown - keep it open for more selections
        }

        function toggleAllFunktion(checkbox) {
            if (checkbox.checked) {
                // When "Alle" gets checked ‚Üí Activate all
                selectedFunktionen = ['EC', 'MA', 'DP', 'TKB', 'FL', 'VW', 'BO'];
                // Immediately update visual checkboxes
                document.querySelectorAll('.funktion-checkbox').forEach(cb => {
                    cb.checked = true;
                });
            } else {
                // When "Alle" gets unchecked ‚Üí Deactivate all
                selectedFunktionen = [];
                // Immediately update visual checkboxes
                document.querySelectorAll('.funktion-checkbox').forEach(cb => {
                    cb.checked = false;
                });
            }
            filterKalender();
        }

        function toggleAllFiliale(checkbox) {
            if (checkbox.checked) {
                // When "Alle" gets checked ‚Üí Activate all
                selectedFilialen = ['AG', 'BO', 'GL', 'GR', 'SG', 'VW', 'ZH', 'ZS'];
                // Immediately update visual checkboxes
                document.querySelectorAll('.filiale-checkbox').forEach(cb => {
                    cb.checked = true;
                });
            } else {
                // When "Alle" gets unchecked ‚Üí Deactivate all
                selectedFilialen = [];
                // Immediately update visual checkboxes
                document.querySelectorAll('.filiale-checkbox').forEach(cb => {
                    cb.checked = false;
                });
            }
            filterKalender();
        }

        function toggleAbwesenheitDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('abwesenheitDropdown');
            dropdown.classList.toggle('show');
        }

        function closeAbwesenheitDropdown() {
            document.getElementById('abwesenheitDropdown').classList.remove('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('abwesenheitDropdown');
            const container = event.target.closest('.dropdown-container');
            if (!container && dropdown) {
                dropdown.classList.remove('show');
            }
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            const clickedInsideFilter = event.target.closest('.filter-label') || 
                                        event.target.closest('.filter-dropdown');
            
            if (!clickedInsideFilter) {
                openDropdownId = null;
                document.querySelectorAll('.filter-dropdown').forEach(d => d.classList.remove('show'));
            }
        });

        function renderKalenderMatrix() {
            const container = document.getElementById('kalenderMatrixContainer');
            
            // Update month title
            const monthNames = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            document.getElementById('kalenderMonthTitle').textContent = 
                `${monthNames[currentKalenderMonth.getMonth()]} ${currentKalenderMonth.getFullYear()}`;

            // Get days in month
            const year = currentKalenderMonth.getFullYear();
            const month = currentKalenderMonth.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Build days array
            const days = [];
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                const dayOfWeek = date.getDay();
                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                const isToday = dateStr === todayStr;
                
                days.push({
                    day,
                    date: dateStr,
                    dayName: ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'][dayOfWeek],
                    isWeekend,
                    isToday
                });
            }

            // Filter active employees using stored filter state
            let filteredEmployees = allMitarbeiter.filter(m => m.aktiv);
            
            // Apply Funktion filter - if empty array, show nothing
            if (selectedFunktionen.length === 0) {
                filteredEmployees = []; // No selections = no employees
            } else {
                filteredEmployees = filteredEmployees.filter(m => selectedFunktionen.includes(m.funktion));
            }
            
            // Apply Filiale filter - if empty array, show nothing
            if (selectedFilialen.length === 0) {
                filteredEmployees = []; // No selections = no employees
            } else if (filteredEmployees.length > 0) {
                filteredEmployees = filteredEmployees.filter(m => selectedFilialen.includes(m.filiale));
            }
            
            // Sort by name
            const activeEmployees = filteredEmployees.sort((a, b) => a.nachname.localeCompare(b.nachname));

            // Build matrix table header
            let html = '<table class="calendar-matrix"><thead><tr>';
            html += '<th>Mitarbeiter</th>';
            html += `<th style="min-width: 90px;" id="funktionHeader">
                <div class="filter-label" onclick="toggleFilterDropdown('funktionFilter', event)">Funktion ‚ñº</div>
            </th>`;
            html += `<th style="min-width: 90px;" id="filialeHeader">
                <div class="filter-label" onclick="toggleFilterDropdown('filialeFilter', event)">Filiale ‚ñº</div>
            </th>`;
            days.forEach(d => {
                const todayClass = d.isToday ? ' class="today-header"' : '';
                html += `<th${todayClass} style="min-width: 30px;">${d.dayName}<br><small>${d.day}</small></th>`;
            });
            html += '</tr></thead><tbody>';

            if (activeEmployees.length === 0) {
                // Still show header with filters even when no employees
                html += '<tr><td colspan="100%" style="padding: 40px; text-align: center; color: var(--text-gray);">Keine Mitarbeiter mit den gew√§hlten Filtern gefunden</td></tr>';
                html += '</tbody></table>';
                container.innerHTML = html;
            } else {
                // Build matrix with employees
                // Rows for each employee
                activeEmployees.forEach(emp => {
                html += `<tr>`;
                html += `<td>${emp.vorname} ${emp.nachname}</td>`;
                html += `<td style="text-align: center; background: var(--bg-light);">${emp.funktion || '-'}</td>`;
                html += `<td style="text-align: center; background: var(--bg-light);">${emp.filiale || '-'}</td>`;
                
                days.forEach(d => {
                    // Find ALL absences for this employee on this date
                    const absences = allAbwesenheiten.filter(a => 
                        parseInt(a.mitarbeiter_id) === emp.id &&
                        d.date >= a.von &&
                        d.date <= a.bis
                    );

                    // Priority logic
                    let absence = null;
                    let hasArbWithBfFt = false; // Special case: ARB + BF/FT
                    
                    if (absences.length > 0) {
                        // Check for ARB first
                        const arbEntry = absences.find(a => a.typ === 'ARB');
                        const bfEntry = absences.find(a => a.typ === 'BF');
                        const ftEntry = absences.find(a => a.typ === 'FT');
                        
                        if (arbEntry && (bfEntry || ftEntry)) {
                            // Special case: ARB + BF/FT ‚Üí show both (diagonal)
                            hasArbWithBfFt = true;
                            absence = bfEntry || ftEntry; // Use BF/FT for reference
                        } else if (arbEntry) {
                            // Only ARB ‚Üí show as available
                            absence = null;
                        } else {
                            // Priority order: FT > BF > UF > KR > FE > KO
                            const priorityOrder = ['FT', 'BF', 'UF', 'KR', 'FE', 'KO'];
                            for (const typ of priorityOrder) {
                                const found = absences.find(a => a.typ === typ);
                                if (found) {
                                    absence = found;
                                    break;
                                }
                            }
                        }
                    }

                    let cellClass = 'calendar-day-cell';
                    if (d.isWeekend) cellClass += ' weekend';
                    if (d.isToday) cellClass += ' today';

                    if (hasArbWithBfFt) {
                        // Diagonal split: BF/FT + ARB (only show BF/FT text)
                        html += `<td><div class="${cellClass}" onclick="editAbwesenheitFromCell(${emp.id}, '${d.date}')">
                            <div class="absence-badge-split">
                                <div class="absence-split-left absence-${absence.typ.toLowerCase()}">${absence.typ}</div>
                                <div class="absence-split-right absence-arb"></div>
                            </div>
                        </div></td>`;
                    } else if (absence) {
                        html += `<td><div class="${cellClass}" onclick="editAbwesenheitFromCell(${emp.id}, '${d.date}')">
                            <div class="absence-badge absence-${absence.typ.toLowerCase()}">${absence.typ}</div>
                        </div></td>`;
                    } else {
                        html += `<td><div class="${cellClass}" onclick="openAbwesenheitDialog(${emp.id}, '${d.date}')"></div></td>`;
                    }
                });
                
                html += '</tr>';
            });

                html += '</tbody></table>';
                container.innerHTML = html;
            }
            
            // Always populate dropdown containers (outside table)
            const funktionDropdown = document.getElementById('funktionFilter');
            funktionDropdown.innerHTML = `
                <label class="filter-option">
                    <input type="checkbox" id="allesFunktionCheckbox" value="all" onchange="toggleAllFunktion(this)"> Alle
                </label>
                <label class="filter-option">
                    <input type="checkbox" class="funktion-checkbox" value="EC" onchange="updateFunktionFilter()"> EC
                </label>
                <label class="filter-option">
                    <input type="checkbox" class="funktion-checkbox" value="MA" onchange="updateFunktionFilter()"> MA
                </label>
                <label class="filter-option">
                    <input type="checkbox" class="funktion-checkbox" value="DP" onchange="updateFunktionFilter()"> DP
                </label>
                <label class="filter-option">
                    <input type="checkbox" class="funktion-checkbox" value="TKB" onchange="updateFunktionFilter()"> TKB
                </label>
                <label class="filter-option">
                    <input type="checkbox" class="funktion-checkbox" value="FL" onchange="updateFunktionFilter()"> FL
                </label>
                <label class="filter-option">
                    <input type="checkbox" class="funktion-checkbox" value="VW" onchange="updateFunktionFilter()"> VW
                </label>
                <label class="filter-option">
                    <input type="checkbox" class="funktion-checkbox" value="BO" onchange="updateFunktionFilter()"> BO
                </label>
            `;
            
            // Now programmatically set checked states
            setTimeout(() => {
                const alleFunktionCb = document.getElementById('allesFunktionCheckbox');
                if (alleFunktionCb) {
                    alleFunktionCb.checked = selectedFunktionen.length === 7;
                    console.log('Alle Funktion checkbox set to:', alleFunktionCb.checked, 'selectedFunktionen:', selectedFunktionen);
                }
                document.querySelectorAll('.funktion-checkbox').forEach(cb => {
                    cb.checked = selectedFunktionen.includes(cb.value);
                });
            }, 0);
            
            const filialeDropdown = document.getElementById('filialeFilter');
            filialeDropdown.innerHTML = `
                <label class="filter-option">
                    <input type="checkbox" id="allesFilialeCheckbox" value="all" onchange="toggleAllFiliale(this)"> Alle
                </label>
                <label class="filter-option">
                    <input type="checkbox" class="filiale-checkbox" value="AG" onchange="updateFilialeFilter()"> AG
                </label>
                <label class="filter-option">
                    <input type="checkbox" class="filiale-checkbox" value="BO" onchange="updateFilialeFilter()"> BO
                </label>
                <label class="filter-option">
                    <input type="checkbox" class="filiale-checkbox" value="GL" onchange="updateFilialeFilter()"> GL
                </label>
                <label class="filter-option">
                    <input type="checkbox" class="filiale-checkbox" value="GR" onchange="updateFilialeFilter()"> GR
                </label>
                <label class="filter-option">
                    <input type="checkbox" class="filiale-checkbox" value="SG" onchange="updateFilialeFilter()"> SG
                </label>
                <label class="filter-option">
                    <input type="checkbox" class="filiale-checkbox" value="VW" onchange="updateFilialeFilter()"> VW
                </label>
                <label class="filter-option">
                    <input type="checkbox" class="filiale-checkbox" value="ZH" onchange="updateFilialeFilter()"> ZH
                </label>
                <label class="filter-option">
                    <input type="checkbox" class="filiale-checkbox" value="ZS" onchange="updateFilialeFilter()"> ZS
                </label>
            `;
            
            // Now programmatically set checked states
            setTimeout(() => {
                const alleFilialeCb = document.getElementById('allesFilialeCheckbox');
                if (alleFilialeCb) {
                    alleFilialeCb.checked = selectedFilialen.length === 8;
                    console.log('Alle Filiale checkbox set to:', alleFilialeCb.checked, 'selectedFilialen:', selectedFilialen);
                }
                document.querySelectorAll('.filiale-checkbox').forEach(cb => {
                    cb.checked = selectedFilialen.includes(cb.value);
                });
            }, 0);
            
            // Re-open and position dropdown if it was open
            if (openDropdownId) {
                positionAndShowDropdown(openDropdownId);
            }
        }

        function openAbwesenheitDialog(mitarbeiterId = null, date = null) {
            if (!canEditCalendar()) {
                alert('‚õî Keine Berechtigung zum Bearbeiten des Kalenders');
                return;
            }

            document.getElementById('abwesenheitDialogTitle').textContent = 'Neue Abwesenheit';
            document.getElementById('abwesenheitForm').reset();
            document.getElementById('editAbwesenheitId').value = '';
            document.getElementById('btnDeleteAbwesenheit').style.display = 'none';

            // Re-enable all form fields
            document.getElementById('inputAbwMitarbeiter').disabled = false;
            document.getElementById('inputAbwTyp').disabled = false;
            document.getElementById('inputAbwVon').disabled = false;
            document.getElementById('inputAbwBis').disabled = false;
            
            // Reset min attribute on Bis field
            document.getElementById('inputAbwBis').removeAttribute('min');

            // Load employee dropdown
            const select = document.getElementById('inputAbwMitarbeiter');
            select.innerHTML = '<option value="">Bitte w√§hlen...</option>';
            allMitarbeiter.filter(m => m.aktiv).forEach(m => {
                const option = document.createElement('option');
                option.value = m.id;
                option.textContent = `${m.vorname} ${m.nachname}`;
                select.appendChild(option);
            });

            // Pre-fill if provided
            if (mitarbeiterId) {
                select.value = mitarbeiterId;
            }
            if (date) {
                document.getElementById('inputAbwVon').value = date;
                document.getElementById('inputAbwBis').value = date;
                calculateAbwTage();
            }

            document.getElementById('abwesenheitDialog').classList.add('show');
        }

        function closeAbwesenheitDialog() {
            document.getElementById('abwesenheitDialog').classList.remove('show');
        }

        function openBetriebsferienDialog() {
            if (!canManageBfFt()) {
                alert('‚õî Keine Berechtigung f√ºr Betriebsferien');
                return;
            }
            if (!canEditCalendar()) {
                alert('‚õî Keine Berechtigung zum Erstellen von Betriebsferien');
                return;
            }
            
            document.getElementById('betriebsferienForm').reset();
            document.getElementById('bfMitarbeiterCount').textContent = 'Keine Mitarbeiter ausgew√§hlt';
            document.getElementById('betriebsferienDialog').classList.add('show');
        }

        function closeBetriebsferienDialog() {
            document.getElementById('betriebsferienDialog').classList.remove('show');
        }

        function calculateBfTage() {
            const von = document.getElementById('inputBfVon').value;
            const bis = document.getElementById('inputBfBis').value;
            
            if (von && bis) {
                const start = new Date(von);
                const end = new Date(bis);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                document.getElementById('inputBfTage').value = diffDays + ' Tage';
            }
        }

        function onBfVonChange() {
            const von = document.getElementById('inputBfVon').value;
            const bisField = document.getElementById('inputBfBis');
            
            if (von) {
                // Set min date for "Bis" to be same or after "Von"
                bisField.min = von;
                
                // If Bis is before Von, clear it
                if (bisField.value && bisField.value < von) {
                    bisField.value = '';
                }
            }
            
            calculateBfTage();
        }

        function updateBfCount() {
            const verwaltung = document.getElementById('bfVerwaltung').checked;
            const filialen = document.getElementById('bfFilialen').checked;
            
            let count = 0;
            let text = '';
            
            if (verwaltung || filialen) {
                const filtered = allMitarbeiter.filter(m => {
                    if (!m.aktiv) return false;
                    if (verwaltung && m.filiale === 'VW') return true;
                    if (filialen && m.filiale !== 'VW') return true;
                    return false;
                });
                
                count = filtered.length;
                
                if (verwaltung && filialen) {
                    text = `${count} Mitarbeiter (Verwaltung + alle Filialen)`;
                } else if (verwaltung) {
                    text = `${count} Mitarbeiter (nur Verwaltung)`;
                } else {
                    text = `${count} Mitarbeiter (nur Filialbetriebe)`;
                }
            } else {
                text = 'Keine Mitarbeiter ausgew√§hlt';
            }
            
            document.getElementById('bfMitarbeiterCount').textContent = text;
        }

        async function saveBetriebsferien(event) {
            event.preventDefault();
            
            const von = document.getElementById('inputBfVon').value;
            const bis = document.getElementById('inputBfBis').value;
            const verwaltung = document.getElementById('bfVerwaltung').checked;
            const filialen = document.getElementById('bfFilialen').checked;
            
            if (!verwaltung && !filialen) {
                alert('‚ö†Ô∏è Bitte w√§hlen Sie mindestens eine Gruppe aus (Verwaltung oder Filialbetriebe)');
                return;
            }
            
            // Get affected employees
            const affectedEmployees = allMitarbeiter.filter(m => {
                if (!m.aktiv) return false;
                if (verwaltung && m.filiale === 'VW') return true;
                if (filialen && m.filiale !== 'VW') return true;
                return false;
            });
            
            if (affectedEmployees.length === 0) {
                alert('‚ö†Ô∏è Keine aktiven Mitarbeiter gefunden');
                return;
            }
            
            // Validate that all employees have valid IDs
            const invalidEmployees = affectedEmployees.filter(emp => !emp.id);
            if (invalidEmployees.length > 0) {
                alert('‚ùå Fehler: Einige Mitarbeiter haben keine g√ºltige ID');
                console.error('Invalid employees:', invalidEmployees);
                return;
            }
            
            // Confirm
            const confirmText = `Betriebsferien erstellen f√ºr ${affectedEmployees.length} Mitarbeiter vom ${von} bis ${bis}?`;
            if (!confirm(confirmText)) return;
            
            try {
                // Calculate days
                const start = new Date(von);
                const end = new Date(bis);
                const diffTime = Math.abs(end - start);
                const tage = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                
                // Create BF entries for all affected employees
                const entries = affectedEmployees.map(emp => ({
                    mitarbeiter_id: emp.id,
                    typ: 'BF',
                    von: von,
                    bis: bis,
                    tage: tage
                }));
                
                console.log('Inserting BF entries:', entries);
                
                // Use array syntax like normal abwesenheit insert
                const { data, error } = await supabaseClient
                    .from('abwesenheits_perioden')
                    .insert(entries);
                
                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }
                
                console.log('Insert successful, count:', entries.length);
                closeBetriebsferienDialog();
                loadKalender();
                
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Fehler beim Erstellen der Betriebsferien: ' + error.message);
            }
        }

        async function editAbwesenheitFromCell(mitarbeiterId, date) {
            if (!canEditCalendar()) {
                return;
            }

            // Find ALL absences for this employee on this date (priority logic)
            const absences = allAbwesenheiten.filter(a => 
                parseInt(a.mitarbeiter_id) === mitarbeiterId &&
                date >= a.von &&
                date <= a.bis
            );

            if (absences.length === 0) return;

            // Apply priority to get the displayed absence
            let absence = null;
            const arbEntry = absences.find(a => a.typ === 'ARB');
            if (arbEntry) {
                absence = arbEntry;
            } else {
                const priorityOrder = ['FT', 'BF', 'UF', 'KR', 'FE', 'KO'];
                for (const typ of priorityOrder) {
                    const found = absences.find(a => a.typ === typ);
                    if (found) {
                        absence = found;
                        break;
                    }
                }
            }

            if (!absence) return;

            // Check if BF (Betriebsferien) or FT (Feiertag) - make read-only
            const isProtected = absence.typ === 'BF' || absence.typ === 'FT';

            // Store the clicked date for deletion
            document.getElementById('clickedDate').value = date;

            // Load into dialog
            let title = 'Abwesenheit bearbeiten';
            if (absence.typ === 'BF') title = 'Betriebsferien (gesch√ºtzt)';
            if (absence.typ === 'FT') title = 'Feiertag (gesch√ºtzt)';
            
            document.getElementById('abwesenheitDialogTitle').textContent = title;
            document.getElementById('editAbwesenheitId').value = absence.id;
            document.getElementById('inputAbwMitarbeiter').value = absence.mitarbeiter_id;
            document.getElementById('inputAbwTyp').value = absence.typ;
            document.getElementById('inputAbwVon').value = absence.von;
            document.getElementById('inputAbwBis').value = absence.bis;
            calculateAbwTage();

            // Hide delete button for BF/FT
            document.getElementById('btnDeleteAbwesenheit').style.display = isProtected ? 'none' : 'block';
            
            // Show "Kann arbeiten" button for BF/FT
            document.getElementById('btnKannArbeiten').style.display = isProtected ? 'block' : 'none';

            // Make BF/FT readonly
            document.getElementById('inputAbwMitarbeiter').disabled = true;
            document.getElementById('inputAbwTyp').disabled = isProtected;
            document.getElementById('inputAbwVon').disabled = isProtected;
            document.getElementById('inputAbwBis').disabled = isProtected;

            // Load employee dropdown
            const select = document.getElementById('inputAbwMitarbeiter');
            select.innerHTML = '<option value="">Bitte w√§hlen...</option>';
            allMitarbeiter.filter(m => m.aktiv).forEach(m => {
                const option = document.createElement('option');
                option.value = m.id;
                option.textContent = `${m.vorname} ${m.nachname}`;
                select.appendChild(option);
            });
            select.value = absence.mitarbeiter_id;

            document.getElementById('abwesenheitDialog').classList.add('show');
        }

        function calculateAbwTage() {
            const von = document.getElementById('inputAbwVon').value;
            const bis = document.getElementById('inputAbwBis').value;

            if (von && bis) {
                const start = new Date(von);
                const end = new Date(bis);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                document.getElementById('inputAbwTage').value = `${diffDays} Tag${diffDays > 1 ? 'e' : ''}`;
            } else {
                document.getElementById('inputAbwTage').value = '';
            }
        }

        function onAbwVonChange() {
            const von = document.getElementById('inputAbwVon').value;
            const bisField = document.getElementById('inputAbwBis');
            
            if (von) {
                // Set min date for "Bis" to be same or after "Von"
                bisField.min = von;
                
                // If Bis is before Von, clear it
                if (bisField.value && bisField.value < von) {
                    bisField.value = '';
                }
            }
            
            calculateAbwTage();
        }

        async function saveAbwesenheit(event) {
            event.preventDefault();

            const editId = document.getElementById('editAbwesenheitId').value;
            const mitarbeiterId = parseInt(document.getElementById('inputAbwMitarbeiter').value);
            const typ = document.getElementById('inputAbwTyp').value;
            const von = document.getElementById('inputAbwVon').value;
            const bis = document.getElementById('inputAbwBis').value;

            try {
                const start = new Date(von);
                const end = new Date(bis);
                const diffTime = Math.abs(end - start);
                const tage = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

                // Weekend logic for FE and KO
                let finalVon = von;
                let finalBis = bis;
                
                if (typ === 'FE' || typ === 'KO') {
                    const startDay = start.getDay(); // 0=Sunday, 1=Monday, ..., 5=Friday
                    const endDay = end.getDay();

                    // If starts on Monday (1), include previous weekend
                    if (startDay === 1) {
                        const prevSaturday = new Date(start);
                        prevSaturday.setDate(start.getDate() - 2);
                        finalVon = prevSaturday.toISOString().split('T')[0];
                    }

                    // If ends on Friday (5), include following weekend
                    if (endDay === 5) {
                        const nextSunday = new Date(end);
                        nextSunday.setDate(end.getDate() + 2);
                        finalBis = nextSunday.toISOString().split('T')[0];
                    }
                }

                // Recalculate days with extended dates
                const finalStart = new Date(finalVon);
                const finalEnd = new Date(finalBis);
                const finalDiffTime = Math.abs(finalEnd - finalStart);
                const finalTage = Math.ceil(finalDiffTime / (1000 * 60 * 60 * 24)) + 1;

                const abwData = {
                    mitarbeiter_id: mitarbeiterId,
                    typ,
                    von: finalVon,
                    bis: finalBis,
                    tage: finalTage,
                    erfasst_am: new Date().toISOString()
                };

                if (editId) {
                    // Update
                    const { error } = await supabaseClient
                        .from('abwesenheits_perioden')
                        .update(abwData)
                        .eq('id', parseInt(editId));

                    if (error) throw error;
                    console.log('‚úÖ Abwesenheit updated');
                } else {
                    // Insert
                    abwData.id = Date.now();
                    const { error } = await supabaseClient
                        .from('abwesenheits_perioden')
                        .insert([abwData]);

                    if (error) throw error;
                    console.log('‚úÖ Abwesenheit created');
                }

                closeAbwesenheitDialog();
                await loadKalender();

            } catch (error) {
                console.error('Error saving abwesenheit:', error);
                alert('Fehler beim Speichern: ' + error.message);
            }
        }

        function kannArbeiten() {
            const mitarbeiterId = parseInt(document.getElementById('inputAbwMitarbeiter').value);
            const bfVon = document.getElementById('inputAbwVon').value;
            const bfBis = document.getElementById('inputAbwBis').value;
            const typ = document.getElementById('inputAbwTyp').value;
            
            const typeName = typ === 'BF' ? 'Betriebsferien' : 'Feiertag';
            
            // Open dialog
            document.getElementById('kannArbTypName').textContent = typeName;
            document.getElementById('kannArbInfo').textContent = `${typeName}-Zeitraum: ${bfVon} bis ${bfBis}`;
            document.getElementById('kannArbMitarbeiterId').value = mitarbeiterId;
            document.getElementById('kannArbOriginalVon').value = bfVon;
            document.getElementById('kannArbOriginalBis').value = bfBis;
            
            // Pre-fill with BF dates
            document.getElementById('inputKannVon').value = bfVon;
            document.getElementById('inputKannVon').min = bfVon;
            document.getElementById('inputKannVon').max = bfBis;
            
            document.getElementById('inputKannBis').value = bfBis;
            document.getElementById('inputKannBis').min = bfVon;
            document.getElementById('inputKannBis').max = bfBis;
            
            calculateKannTage();
            
            document.getElementById('kannArbeitenDialog').classList.add('show');
        }

        function closeKannArbeitenDialog() {
            document.getElementById('kannArbeitenDialog').classList.remove('show');
        }

        function openLoeschenDialog() {
            if (!canManageBfFt()) {
                alert('‚õî Keine Berechtigung zum Verwalten');
                return;
            }
            if (!canEditCalendar()) {
                alert('‚õî Keine Berechtigung zum Verwalten');
                return;
            }
            
            document.getElementById('inputVerwaltenTyp').value = '';
            document.getElementById('bfFtListContainer').style.display = 'none';
            document.getElementById('loeschenDialog').classList.add('show');
        }

        function closeLoeschenDialog() {
            document.getElementById('loeschenDialog').classList.remove('show');
        }

        function loadBfFtList() {
            const typ = document.getElementById('inputVerwaltenTyp').value;
            
            if (!typ) {
                document.getElementById('bfFtListContainer').style.display = 'none';
                return;
            }
            
            const typName = typ === 'BF' ? 'Betriebsferien' : 'Feiertage';
            const today = new Date().toISOString().split('T')[0];
            
            // Get all future entries of this type
            const futureEntries = allAbwesenheiten.filter(a => 
                a.typ === typ && a.von >= today
            );
            
            if (futureEntries.length === 0) {
                document.getElementById('bfFtList').innerHTML = `
                    <p style="text-align: center; padding: 40px; color: var(--text-gray);">
                        Keine zuk√ºnftigen ${typName} gefunden
                    </p>
                `;
                document.getElementById('bfFtListContainer').style.display = 'block';
                return;
            }
            
            // Group by date pattern (MM-DD) to detect recurring
            const patterns = {};
            futureEntries.forEach(entry => {
                const vonParts = entry.von.split('-');
                const bisParts = entry.bis.split('-');
                const pattern = `${vonParts[1]}-${vonParts[2]}_${bisParts[1]}-${bisParts[2]}`;
                
                if (!patterns[pattern]) {
                    patterns[pattern] = {
                        monthDay: `${vonParts[2]}.${vonParts[1]}`,
                        monthDayBis: `${bisParts[2]}.${bisParts[1]}`,
                        years: {},
                        entries: []
                    };
                }
                
                const year = vonParts[0];
                if (!patterns[pattern].years[year]) {
                    patterns[pattern].years[year] = [];
                }
                patterns[pattern].years[year].push(entry);
                patterns[pattern].entries.push(entry);
            });
            
            // Build HTML - group recurring vs single
            let html = '';
            
            Object.entries(patterns).forEach(([pattern, data]) => {
                const yearList = Object.keys(data.years).sort();
                const isRecurring = yearList.length > 1;
                const mitarbeiterCount = data.years[yearList[0]].length;
                
                if (isRecurring) {
                    // Recurring entry - show once with year range
                    const yearRange = `${yearList[0]} - ${yearList[yearList.length - 1]}`;
                    const totalEntries = data.entries.length;
                    
                    html += `
                        <div style="padding: 12px; margin-bottom: 8px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div>
                                    <strong>üîÅ ${data.monthDay} - ${data.monthDayBis}</strong>
                                    <br>
                                    <small style="color: var(--text-gray);">
                                        ${mitarbeiterCount} Mitarbeiter √ó ${yearList.length} Jahre (${yearRange})
                                        <br>
                                        Insgesamt ${totalEntries} Eintr√§ge
                                    </small>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" 
                                            onclick='editBfFtGroup(${JSON.stringify(data.entries)})'>
                                        ‚úèÔ∏è Bearbeiten
                                    </button>
                                    <button class="btn" style="background: var(--danger); color: white; padding: 6px 12px; font-size: 13px;" 
                                            onclick='deleteBfFtRecurring(${JSON.stringify(data.entries)}, "${typ}", "${data.monthDay} - ${data.monthDayBis}")'>
                                        üóëÔ∏è Alle l√∂schen
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Single entry
                    const year = yearList[0];
                    const entries = data.years[year];
                    
                    html += `
                        <div style="padding: 12px; margin-bottom: 8px; background: var(--bg-light); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${entries[0].von} - ${entries[0].bis}</strong>
                                    <br>
                                    <small style="color: var(--text-gray);">${mitarbeiterCount} Mitarbeiter</small>
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;" 
                                            onclick='editBfFtGroup(${JSON.stringify(entries)})'>
                                        ‚úèÔ∏è Bearbeiten
                                    </button>
                                    <button class="btn" style="background: var(--danger); color: white; padding: 6px 12px; font-size: 13px;" 
                                            onclick="deleteBfFtGroup('${typ}', '${entries[0].von}', '${entries[0].bis}', ${mitarbeiterCount})">
                                        üóëÔ∏è L√∂schen
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            
            document.getElementById('bfFtList').innerHTML = html;
            document.getElementById('bfFtListContainer').style.display = 'block';
        }

        function editBfFtGroup(entries) {
            const first = entries[0];
            const uniqueYears = [...new Set(entries.map(e => e.von.split('-')[0]))].sort();
            const isRecurring = uniqueYears.length > 1;
            
            // Get which filialen are actually in the entries
            const filialeMap = {};
            entries.forEach(e => {
                const emp = allMitarbeiter.find(m => parseInt(m.id) === parseInt(e.mitarbeiter_id));
                if (emp && emp.filiale) {
                    filialeMap[emp.filiale] = true;
                }
            });
            let activeFilialen = Object.keys(filialeMap);
            
            // Smart detection: If 7+ filialen present, assume all were selected
            // (some filialen might just have no employees)
            const allPossibleFilialen = ['VW', 'AG', 'BO', 'GL', 'GR', 'SG', 'ZH', 'ZS'];
            if (activeFilialen.length >= 7) {
                activeFilialen = allPossibleFilialen;
            }
            
            console.log('=== EDIT DEBUG ===');
            console.log('Total entries:', entries.length);
            console.log('Total mitarbeiter:', allMitarbeiter.length);
            console.log('Filialen with employees:', Object.keys(filialeMap));
            console.log('Active filialen (after smart detection):', activeFilialen);
            
            // Set title
            if (isRecurring) {
                document.getElementById('editBfFtTitle').textContent = `üîÅ J√§hrlich bearbeiten`;
            } else {
                document.getElementById('editBfFtTitle').textContent = 'Eintrag bearbeiten';
            }
            
            // Fill form
            document.getElementById('inputEditVon').value = first.von;
            document.getElementById('inputEditBis').value = first.bis;
            document.getElementById('editBfFtEntries').value = JSON.stringify(entries);
            document.getElementById('editBfFtTyp').value = first.typ;
            document.getElementById('editBfFtIsRecurring').value = isRecurring;
            
            // Set filialen checkboxes - CHECK if filiale IS in entries
            document.querySelectorAll('.edit-filiale-checkbox').forEach(cb => {
                const shouldCheck = activeFilialen.includes(cb.value);
                cb.checked = shouldCheck;
                console.log(`Checkbox ${cb.value}: ${shouldCheck}`);
            });
            
            document.getElementById('editBfFtDialog').classList.add('show');
        }

        function closeEditBfFtDialog() {
            document.getElementById('editBfFtDialog').classList.remove('show');
        }

        async function saveEditBfFt(event) {
            event.preventDefault();
            
            const entries = JSON.parse(document.getElementById('editBfFtEntries').value);
            const typ = document.getElementById('editBfFtTyp').value;
            const isRecurring = document.getElementById('editBfFtIsRecurring').value === 'true';
            const newVon = document.getElementById('inputEditVon').value;
            const newBis = document.getElementById('inputEditBis').value;
            const newFilialen = Array.from(document.querySelectorAll('.edit-filiale-checkbox:checked')).map(cb => cb.value);
            
            if (newFilialen.length === 0) {
                alert('‚ö†Ô∏è Bitte w√§hlen Sie mindestens eine Filiale aus');
                return;
            }
            
            const typName = typ === 'BF' ? 'Betriebsferien' : 'Feiertag';
            
            // Get old filialen
            const oldFilialeMap = {};
            entries.forEach(e => {
                const emp = allMitarbeiter.find(m => m.id === e.mitarbeiter_id);
                if (emp) oldFilialeMap[emp.filiale] = true;
            });
            const oldFilialen = Object.keys(oldFilialeMap);
            
            // Check what changed
            const vonParts = entries[0].von.split('-');
            const newVonParts = newVon.split('-');
            const dateChanged = vonParts[1] !== newVonParts[1] || vonParts[2] !== newVonParts[2];
            const filialeChanged = JSON.stringify(oldFilialen.sort()) !== JSON.stringify(newFilialen.sort());
            
            if (!dateChanged && !filialeChanged) {
                alert('‚ö†Ô∏è Keine √Ñnderungen vorgenommen');
                return;
            }
            
            let confirmText = `${typName} aktualisieren?\n\n`;
            if (dateChanged) confirmText += `Neues Datum: ${newVon} - ${newBis}\n`;
            if (filialeChanged) confirmText += `Filialen: ${newFilialen.join(', ')}\n`;
            
            if (!confirm(confirmText)) return;
            
            try {
                // Delete old entries
                const oldIds = entries.map(e => e.id);
                await supabaseClient
                    .from('abwesenheits_perioden')
                    .delete()
                    .in('id', oldIds);
                
                // Get affected employees with new filialen
                const affectedEmployees = allMitarbeiter.filter(m => 
                    m.aktiv && newFilialen.includes(m.filiale)
                );
                
                // Calculate days
                const start = new Date(newBis);
                const end = new Date(newVon);
                const diffTime = Math.abs(start - end);
                const tage = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                
                // Create new entries
                const newEntries = [];
                
                if (isRecurring) {
                    // Recreate for all years
                    const years = [...new Set(entries.map(e => e.von.split('-')[0]))].sort();
                    years.forEach(year => {
                        const yearVon = `${year}-${newVonParts[1]}-${newVonParts[2]}`;
                        const yearBis = `${year}-${newBis.split('-')[1]}-${newBis.split('-')[2]}`;
                        
                        affectedEmployees.forEach(emp => {
                            newEntries.push({
                                mitarbeiter_id: emp.id,
                                typ: typ,
                                von: yearVon,
                                bis: yearBis,
                                tage: tage
                            });
                        });
                    });
                } else {
                    // Single entry
                    affectedEmployees.forEach(emp => {
                        newEntries.push({
                            mitarbeiter_id: emp.id,
                            typ: typ,
                            von: newVon,
                            bis: newBis,
                            tage: tage
                        });
                    });
                }
                
                const { error } = await supabaseClient
                    .from('abwesenheits_perioden')
                    .insert(newEntries);
                
                if (error) throw error;
                
                closeEditBfFtDialog();
                closeLoeschenDialog();
                await loadKalender();
                
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Fehler beim Bearbeiten: ' + error.message);
            }
        }

        async function deleteBfFtRecurring(entries, typ, displayName) {
            const typName = typ === 'BF' ? 'Betriebsferien' : 'Feiertag';
            
            const confirmText = `${typName} l√∂schen?\n\nüîÅ ${displayName}\n\n‚ö†Ô∏è Dies kann nicht r√ºckg√§ngig gemacht werden!`;
            if (!confirm(confirmText)) return;
            
            try {
                const ids = entries.map(e => e.id);
                
                const { error } = await supabaseClient
                    .from('abwesenheits_perioden')
                    .delete()
                    .in('id', ids);
                
                if (error) throw error;
                
                await loadKalender();
                loadBfFtList(); // Refresh list
                
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Fehler beim L√∂schen: ' + error.message);
            }
        }

        async function deleteBfFtGroup(typ, von, bis, count) {
            const typName = typ === 'BF' ? 'Betriebsferien' : 'Feiertag';
            
            const confirmText = `${typName} l√∂schen?\n\nZeitraum: ${von} - ${bis}\n\n‚ö†Ô∏è Dies kann nicht r√ºckg√§ngig gemacht werden!`;
            if (!confirm(confirmText)) return;
            
            try {
                const { error } = await supabaseClient
                    .from('abwesenheits_perioden')
                    .delete()
                    .eq('typ', typ)
                    .eq('von', von)
                    .eq('bis', bis);
                
                if (error) throw error;
                
                await loadKalender();
                loadBfFtList(); // Refresh list
                
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Fehler beim L√∂schen: ' + error.message);
            }
        }

        function openFeiertagDialog() {
            if (!canManageBfFt()) {
                alert('‚õî Keine Berechtigung f√ºr Feiertage');
                return;
            }
            if (!canEditCalendar()) {
                alert('‚õî Keine Berechtigung zum Erstellen von Feiertagen');
                return;
            }
            
            document.getElementById('feiertagForm').reset();
            
            // Check all filialen by default
            document.querySelectorAll('.ft-filiale-checkbox').forEach(cb => cb.checked = true);
            document.getElementById('ftJaehrlich').checked = false;
            
            updateFtCount();
            document.getElementById('feiertagDialog').classList.add('show');
        }

        function closeFeiertagDialog() {
            document.getElementById('feiertagDialog').classList.remove('show');
        }

        function onFtVonChange() {
            const von = document.getElementById('inputFtVon').value;
            const bisField = document.getElementById('inputFtBis');
            
            if (von) {
                bisField.min = von;
                if (bisField.value && bisField.value < von) {
                    bisField.value = '';
                }
            }
            
            calculateFtTage();
        }

        function calculateFtTage() {
            const von = document.getElementById('inputFtVon').value;
            const bis = document.getElementById('inputFtBis').value;
            
            if (von && bis) {
                const start = new Date(von);
                const end = new Date(bis);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                document.getElementById('inputFtTage').value = diffDays + ' Tage';
            }
        }

        function updateFtCount() {
            const selectedFilialen = Array.from(document.querySelectorAll('.ft-filiale-checkbox:checked')).map(cb => cb.value);
            
            if (selectedFilialen.length === 0) {
                document.getElementById('ftMitarbeiterCount').textContent = 'Keine Filialen ausgew√§hlt';
                return;
            }
            
            const filtered = allMitarbeiter.filter(m => {
                return m.aktiv && selectedFilialen.includes(m.filiale);
            });
            
            const count = filtered.length;
            const filialeText = selectedFilialen.join(', ');
            
            document.getElementById('ftMitarbeiterCount').textContent = `${count} Mitarbeiter (${filialeText})`;
        }

        async function saveFeiertag(event) {
            event.preventDefault();
            
            const name = document.getElementById('inputFtName').value;
            const von = document.getElementById('inputFtVon').value;
            const bis = document.getElementById('inputFtBis').value;
            const selectedFilialen = Array.from(document.querySelectorAll('.ft-filiale-checkbox:checked')).map(cb => cb.value);
            const jaehrlich = document.getElementById('ftJaehrlich').checked;
            
            if (selectedFilialen.length === 0) {
                alert('‚ö†Ô∏è Bitte w√§hlen Sie mindestens eine Filiale aus');
                return;
            }
            
            // Get affected employees
            const affectedEmployees = allMitarbeiter.filter(m => {
                return m.aktiv && selectedFilialen.includes(m.filiale);
            });
            
            if (affectedEmployees.length === 0) {
                alert('‚ö†Ô∏è Keine aktiven Mitarbeiter gefunden');
                return;
            }
            
            // If yearly, create for 50 years
            const years = jaehrlich ? 50 : 1;
            const totalEntries = affectedEmployees.length * years;
            
            // Confirm
            let confirmText = `Feiertag "${name}" erstellen f√ºr ${affectedEmployees.length} Mitarbeiter vom ${von} bis ${bis}?`;
            if (jaehrlich) {
                confirmText += `\n\nüîÅ J√§hrlich wiederkehrend`;
            }
            if (!confirm(confirmText)) return;
            
            try {
                // Calculate days
                const start = new Date(von);
                const end = new Date(bis);
                const diffTime = Math.abs(end - start);
                const tage = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                
                // Create FT entries for all affected employees and years
                const entries = [];
                
                for (let year = 0; year < years; year++) {
                    const yearVon = new Date(von);
                    yearVon.setFullYear(yearVon.getFullYear() + year);
                    const yearBis = new Date(bis);
                    yearBis.setFullYear(yearBis.getFullYear() + year);
                    
                    affectedEmployees.forEach(emp => {
                        entries.push({
                            mitarbeiter_id: emp.id,
                            typ: 'FT',
                            von: yearVon.toISOString().split('T')[0],
                            bis: yearBis.toISOString().split('T')[0],
                            tage: tage
                        });
                    });
                }
                
                console.log('Inserting FT entries:', entries.length, 'entries');
                
                const { data, error } = await supabaseClient
                    .from('abwesenheits_perioden')
                    .insert(entries);
                
                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }
                
                console.log('Insert successful');
                closeFeiertagDialog();
                loadKalender();
                
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Fehler beim Erstellen des Feiertags: ' + error.message);
            }
        }

        function onKannVonChange() {
            const von = document.getElementById('inputKannVon').value;
            const bisField = document.getElementById('inputKannBis');
            
            if (von) {
                bisField.min = von;
                if (bisField.value && bisField.value < von) {
                    bisField.value = '';
                }
            }
            
            calculateKannTage();
        }

        function calculateKannTage() {
            const von = document.getElementById('inputKannVon').value;
            const bis = document.getElementById('inputKannBis').value;
            
            if (von && bis) {
                const start = new Date(von);
                const end = new Date(bis);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                document.getElementById('inputKannTage').value = diffDays + ' Tage';
            }
        }

        async function saveKannArbeiten(event) {
            event.preventDefault();
            
            const mitarbeiterId = parseInt(document.getElementById('kannArbMitarbeiterId').value);
            const von = document.getElementById('inputKannVon').value;
            const bis = document.getElementById('inputKannBis').value;
            const originalVon = document.getElementById('kannArbOriginalVon').value;
            const originalBis = document.getElementById('kannArbOriginalBis').value;
            
            // Validate within original range
            if (von < originalVon || bis > originalBis) {
                alert(`‚ö†Ô∏è Der gew√§hlte Zeitraum muss innerhalb ${originalVon} - ${originalBis} liegen!`);
                return;
            }
            
            try {
                // Calculate days
                const start = new Date(von);
                const end = new Date(bis);
                const diffTime = Math.abs(end - start);
                const tage = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                
                // Create ARB entry
                const arbData = {
                    mitarbeiter_id: mitarbeiterId,
                    typ: 'ARB',
                    von: von,
                    bis: bis,
                    tage: tage
                };
                
                const { error } = await supabaseClient
                    .from('abwesenheits_perioden')
                    .insert([arbData]);
                
                if (error) throw error;
                
                closeKannArbeitenDialog();
                closeAbwesenheitDialog();
                await loadKalender();
                
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Fehler: ' + error.message);
            }
        }

        async function deleteAbwesenheit() {
            const id = document.getElementById('editAbwesenheitId').value;
            if (!id) return;

            // Get the current absence
            const currentAbsence = allAbwesenheiten.find(a => a.id === parseInt(id));
            if (!currentAbsence) return;

            // BF (Betriebsferien) and FT (Feiertag) cannot be deleted
            if (currentAbsence.typ === 'BF' || currentAbsence.typ === 'FT') {
                alert('‚õî Betriebsferien und Feiertage k√∂nnen nicht gel√∂scht werden!');
                return;
            }

            // Get the dates from the dialog (user might have changed them)
            const deleteVon = document.getElementById('inputAbwVon').value;
            const deleteBis = document.getElementById('inputAbwBis').value;
            const originalVon = currentAbsence.von;
            const originalBis = currentAbsence.bis;

            if (!confirm(`M√∂chten Sie die Abwesenheit vom ${deleteVon} bis ${deleteBis} l√∂schen?`)) {
                return;
            }

            try {
                // Case 1: Delete range matches entire period - delete completely
                if (deleteVon === originalVon && deleteBis === originalBis) {
                    await supabaseClient
                        .from('abwesenheits_perioden')
                        .delete()
                        .eq('id', parseInt(id));
                }
                // Case 2: Delete from beginning - keep end part
                else if (deleteVon === originalVon && deleteBis < originalBis) {
                    const newVon = new Date(deleteBis);
                    newVon.setDate(newVon.getDate() + 1);
                    const newVonStr = newVon.toISOString().split('T')[0];
                    
                    const start = new Date(newVonStr);
                    const end = new Date(originalBis);
                    const diffTime = Math.abs(end - start);
                    const newTage = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    
                    await supabaseClient
                        .from('abwesenheits_perioden')
                        .update({ 
                            von: newVonStr,
                            tage: newTage
                        })
                        .eq('id', parseInt(id));
                }
                // Case 3: Delete from end - keep beginning part
                else if (deleteVon > originalVon && deleteBis === originalBis) {
                    const newBis = new Date(deleteVon);
                    newBis.setDate(newBis.getDate() - 1);
                    const newBisStr = newBis.toISOString().split('T')[0];
                    
                    const start = new Date(originalVon);
                    const end = new Date(newBisStr);
                    const diffTime = Math.abs(end - start);
                    const newTage = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    
                    await supabaseClient
                        .from('abwesenheits_perioden')
                        .update({ 
                            bis: newBisStr,
                            tage: newTage
                        })
                        .eq('id', parseInt(id));
                }
                // Case 4: Delete from middle - split into two periods
                else if (deleteVon > originalVon && deleteBis < originalBis) {
                    const dayBeforeDelete = new Date(deleteVon);
                    dayBeforeDelete.setDate(dayBeforeDelete.getDate() - 1);
                    const dayBeforeStr = dayBeforeDelete.toISOString().split('T')[0];
                    
                    const dayAfterDelete = new Date(deleteBis);
                    dayAfterDelete.setDate(dayAfterDelete.getDate() + 1);
                    const dayAfterStr = dayAfterDelete.toISOString().split('T')[0];
                    
                    // Calculate days for first period
                    const start1 = new Date(originalVon);
                    const end1 = new Date(dayBeforeStr);
                    const diffTime1 = Math.abs(end1 - start1);
                    const tage1 = Math.ceil(diffTime1 / (1000 * 60 * 60 * 24)) + 1;
                    
                    // Calculate days for second period
                    const start2 = new Date(dayAfterStr);
                    const end2 = new Date(originalBis);
                    const diffTime2 = Math.abs(end2 - start2);
                    const tage2 = Math.ceil(diffTime2 / (1000 * 60 * 60 * 24)) + 1;
                    
                    // Update existing period to end before delete range
                    await supabaseClient
                        .from('abwesenheits_perioden')
                        .update({ 
                            bis: dayBeforeStr,
                            tage: tage1
                        })
                        .eq('id', parseInt(id));
                    
                    // Create new period starting after delete range
                    const newPeriod = {
                        id: Date.now(),
                        mitarbeiter_id: currentAbsence.mitarbeiter_id,
                        typ: currentAbsence.typ,
                        von: dayAfterStr,
                        bis: originalBis,
                        tage: tage2,
                        erfasst_am: new Date().toISOString()
                    };
                    
                    await supabaseClient
                        .from('abwesenheits_perioden')
                        .insert([newPeriod]);
                } else {
                    alert('‚ö†Ô∏è Ung√ºltiger L√∂schbereich. Bitte passen Sie die Daten an.');
                    return;
                }

                console.log('‚úÖ Abwesenheit gel√∂scht/angepasst');
                closeAbwesenheitDialog();
                await loadKalender();

            } catch (error) {
                console.error('Error deleting:', error);
                alert('Fehler beim L√∂schen: ' + error.message);
            }
        }

        function updateNavigationVisibility() {
            // Hide navigation items based on permissions
            const navItems = document.querySelectorAll('.header-nav-item[data-permission]');
            
            navItems.forEach(item => {
                const permission = item.getAttribute('data-permission');
                if (!hasPermission(permission)) {
                    item.style.display = 'none';
                }
            });
            
            // Show/hide BF/FT dropdown items
            if (canManageBfFt()) {
                document.getElementById('dropdownBetriebsferien').style.display = 'block';
                document.getElementById('dropdownFeiertage').style.display = 'block';
                document.getElementById('dropdownBfFtLoeschen').style.display = 'block';
            } else {
                document.getElementById('dropdownBetriebsferien').style.display = 'none';
                document.getElementById('dropdownFeiertage').style.display = 'none';
                document.getElementById('dropdownBfFtLoeschen').style.display = 'none';
            }
        }

        // ============================================
        // ADMIN PANEL
        // ============================================
        let allRoles = [];

        function openBerechtigungen() {
            if (!isAdmin()) {
                alert('‚õî Nur f√ºr Administratoren zug√§nglich');
                return; // Stop here - don't open modal
            }
            
            document.getElementById('userDropdown').classList.remove('show');
            loadBerechtigungen();
            document.getElementById('berechtigungenModal').classList.add('show');
        }

        function closeBerechtigungen() {
            document.getElementById('berechtigungenModal').classList.remove('show');
        }

        async function loadBerechtigungen() {
            // No need to check again - already checked in openBerechtigungen

            try {
                const [rolesRes, usersRes, stvRes] = await Promise.all([
                    supabaseClient.from('role_permissions').select('*').order('id'),
                    supabaseClient.from('system_users').select('id, name, role, active').eq('active', true),
                    supabaseClient.from('admin_stellvertreter').select('stellvertreter_user_id')
                ]);

                if (rolesRes.error) throw rolesRes.error;
                if (usersRes.error) throw usersRes.error;

                allRoles = rolesRes.data || [];
                
                // Show stellvertreter section only for primary admins (not stellvertreter themselves)
                const stellvertreterSection = document.getElementById('stellvertreterSection');
                if (currentUser.role === 'admin' && !currentUser.isStellvertreter) {
                    stellvertreterSection.style.display = 'block';
                    renderStellvertreter(usersRes.data || [], stvRes.data || []);
                } else {
                    stellvertreterSection.style.display = 'none';
                }
                
                // Render roles
                renderRolesPermissions();

                console.log('‚úÖ Berechtigungen loaded');
            } catch (error) {
                console.error('Error loading berechtigungen:', error);
            }
        }

        function renderStellvertreter(allUsers, currentStv) {
            const container = document.getElementById('stellvertreterContainer');
            
            // Filter out current admin and other admins
            const availableUsers = allUsers.filter(u => u.id !== currentUser.id && u.role !== 'admin');
            
            // Get current stellvertreter IDs
            const stvIds = currentStv.map(s => s.stellvertreter_user_id);

            const roleColors = {
                'disponent': { bg: '#dbeafe', color: '#1e40af' },
                'tkb': { bg: '#d1fae5', color: '#065f46' },
                'geschaeftsleitung': { bg: '#fef3c7', color: '#92400e' },
                'backoffice': { bg: '#ede9fe', color: '#5b21b6' },
                'equipenchef': { bg: '#cffafe', color: '#164e63' }
            };

            const html = availableUsers.map(user => {
                const isStv = stvIds.includes(user.id);
                const roleInfo = roleColors[user.role] || { bg: '#f3f4f6', color: '#374151' };
                const roleDisplay = getRoleDisplayName(user.role);

                return `
                    <label class="stv-checkbox-item">
                        <input 
                            type="checkbox" 
                            ${isStv ? 'checked' : ''}
                            onchange="toggleStellvertreter(${user.id}, this.checked)"
                        >
                        <span class="stv-checkbox-label">${user.name}</span>
                        <span class="stv-role-badge" style="background: ${roleInfo.bg}; color: ${roleInfo.color};">
                            ${roleDisplay.split(' - ')[0]}
                        </span>
                    </label>
                `;
            }).join('');

            container.innerHTML = html || '<p style="color: var(--text-gray); font-size: 14px;">Keine verf√ºgbaren Benutzer</p>';
        }

        async function toggleStellvertreter(userId, isChecked) {
            try {
                if (isChecked) {
                    // Add stellvertreter
                    const { error } = await supabaseClient
                        .from('admin_stellvertreter')
                        .insert([{
                            admin_user_id: currentUser.id,
                            stellvertreter_user_id: userId
                        }]);

                    if (error) throw error;
                    console.log('‚úÖ Stellvertreter added:', userId);
                } else {
                    // Remove stellvertreter
                    const { error } = await supabaseClient
                        .from('admin_stellvertreter')
                        .delete()
                        .eq('admin_user_id', currentUser.id)
                        .eq('stellvertreter_user_id', userId);

                    if (error) throw error;
                    console.log('‚úÖ Stellvertreter removed:', userId);
                }

                showSaveIndicator();

            } catch (error) {
                console.error('Error toggling stellvertreter:', error);
                alert('Fehler: ' + error.message);
                // Revert checkbox
                event.target.checked = !isChecked;
            }
        }

        function isAdmin() {
            if (!currentUser) return false;
            
            // Check if user is actual admin
            if (currentUser.role === 'admin') return true;
            
            // Check if user is stellvertreter (will be checked at login)
            if (currentUser.isStellvertreter) return true;
            
            return false;
        }

        async function loadAdminPanel() {
            // Deprecated - now using modal
            openBerechtigungen();
        }

        function renderRolesPermissions() {
            const container = document.getElementById('rolesPermissionsModalContainer');

            const roleInfo = {
                'admin': { name: 'AD - Administrator', color: '#ef4444', desc: 'Volle Systemrechte' },
                'disponent': { name: 'D - Disponent', color: '#3b82f6', desc: 'Disposition und Planung' },
                'tkb': { name: 'TKB - Technischer Kundenberater', color: '#10b981', desc: 'Technische Beratung' },
                'geschaeftsleitung': { name: 'GL - Gesch√§ftsleitung', color: '#f59e0b', desc: '√úbersicht und Reports' },
                'backoffice': { name: 'BO - Backoffice', color: '#8b5cf6', desc: 'B√ºro und Verwaltung' },
                'equipenchef': { name: 'EC - Equipenchef', color: '#06b6d4', desc: 'Mobile Tagesprogramm-Ansicht' }
            };

            const permissionLabels = {
                'canViewPersonal': { label: 'Personal ansehen', icon: 'üë•' },
                'canEditPersonal': { label: 'Personal bearbeiten', icon: '‚úèÔ∏è' },
                'canDeletePersonal': { label: 'Personal l√∂schen', icon: 'üóëÔ∏è' },
                'canViewCalendar': { label: 'Kalender ansehen', icon: 'üìÖ' },
                'canEditCalendar': { label: 'Kalender bearbeiten', icon: '‚úèÔ∏è' },
                'canManageBfFt': { label: 'Betriebsferien/Feiertage verwalten', icon: 'üéâ' },
                'canViewAuftraege': { label: 'Auftr√§ge ansehen', icon: 'üìã' },
                'canCreateAuftraege': { label: 'Auftr√§ge erstellen', icon: '‚ûï' },
                'canEditAuftraege': { label: 'Auftr√§ge bearbeiten', icon: '‚úèÔ∏è' },
                'canDeleteAuftraege': { label: 'Auftr√§ge l√∂schen', icon: 'üóëÔ∏è' },
                'canViewTagesprogramm': { label: 'Tagesprogramm ansehen', icon: 'üóìÔ∏è' },
                'canEditEquipe': { label: 'Equipe zuteilen', icon: 'üë∑' },
                'canPrint': { label: 'Drucken', icon: 'üñ®Ô∏è' },
                'canExportImport': { label: 'Export/Import', icon: 'üì§' },
                'canViewSettings': { label: 'Einstellungen', icon: '‚öôÔ∏è' }
            };

            const html = allRoles.map(role => {
                const info = roleInfo[role.role] || { name: role.role, color: '#6b7280', desc: '' };
                const permissions = role.permissions || {};

                return `
                    <div class="role-card">
                        <div class="role-header">
                            <div>
                                <div class="role-title">${info.name}</div>
                                <div style="color: var(--text-gray); font-size: 13px; margin-top: 4px;">${info.desc}</div>
                            </div>
                            <div class="role-badge-large" style="background: ${info.color}20; color: ${info.color};">
                                ${role.role.toUpperCase()}
                            </div>
                        </div>
                        
                        <div class="permissions-grid">
                            ${Object.keys(permissionLabels).map(perm => `
                                <div class="permission-item">
                                    <input 
                                        type="checkbox" 
                                        class="permission-checkbox"
                                        id="perm_${role.role}_${perm}"
                                        ${permissions[perm] ? 'checked' : ''}
                                        onchange="updatePermission('${role.role}', '${perm}', this.checked)"
                                        ${role.role === 'admin' ? 'disabled' : ''}
                                    >
                                    <label class="permission-label" for="perm_${role.role}_${perm}">
                                        <span class="permission-icon">${permissionLabels[perm].icon}</span>
                                        ${permissionLabels[perm].label}
                                    </label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        async function updatePermission(role, permission, value) {
            try {
                // Find role
                const roleData = allRoles.find(r => r.role === role);
                if (!roleData) return;

                // Update permission
                roleData.permissions[permission] = value;

                // Save to database
                const { error } = await supabaseClient
                    .from('role_permissions')
                    .update({ permissions: roleData.permissions })
                    .eq('role', role);

                if (error) throw error;

                console.log(`‚úÖ Permission updated: ${role}.${permission} = ${value}`);
                
                // Show save indicator
                showSaveIndicator();

                // If current user's role was changed, reload their permissions
                if (currentUser.role === role) {
                    currentUser.permissions = roleData.permissions;
                    sessionStorage.setItem('morfUser', JSON.stringify(currentUser));
                    updateNavigationVisibility();
                }

            } catch (error) {
                console.error('Error updating permission:', error);
                alert('Fehler beim Speichern: ' + error.message);
                // Revert checkbox
                document.getElementById(`perm_${role}_${permission}`).checked = !value;
            }
        }

        function showSaveIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'save-indicator';
            indicator.innerHTML = '‚úÖ Gespeichert';
            document.body.appendChild(indicator);

            setTimeout(() => indicator.classList.add('show'), 10);
            setTimeout(() => {
                indicator.classList.remove('show');
                setTimeout(() => indicator.remove(), 300);
            }, 2000);
        }

        // ============================================
        // PERMISSIONS SYSTEM
        // ============================================
        function hasPermission(permission) {
            if (!currentUser) return false;
            
            // Admin has all rights
            if (currentUser.role === 'admin') return true;
            
            // Stellvertreter also has all rights (without changing role permissions)
            if (currentUser.isStellvertreter) return true;
            
            // Normal users: check their role permissions
            return currentUser.permissions && currentUser.permissions[permission] === true;
        }

        function canViewPersonal() {
            return hasPermission('canViewPersonal');
        }

        function canEditPersonal() {
            return hasPermission('canEditPersonal');
        }

        function canDeletePersonal() {
            return hasPermission('canDeletePersonal');
        }

        function canViewCalendar() {
            return hasPermission('canViewCalendar');
        }

        function canEditCalendar() {
            return hasPermission('canEditCalendar');
        }

        function canManageBfFt() {
            return hasPermission('canManageBfFt');
        }

        function canViewAuftraege() {
            return hasPermission('canViewAuftraege');
        }

        function canCreateAuftraege() {
            return hasPermission('canCreateAuftraege');
        }

        function canEditAuftraege() {
            return hasPermission('canEditAuftraege');
        }

        function canDeleteAuftraege() {
            return hasPermission('canDeleteAuftraege');
        }

        function canViewTagesprogramm() {
            return hasPermission('canViewTagesprogramm');
        }

        function canEditEquipe() {
            return hasPermission('canEditEquipe');
        }

        // ============================================
        // DATA LOADING
        // ============================================
        let allMitarbeiter = [];

        async function loadDashboardData() {
            try {
                // Load stats
                const [mitarbeiterRes, auftraegeRes, abwesenheitenRes] = await Promise.all([
                    supabaseClient.from('mitarbeiter').select('*', { count: 'exact' }),
                    supabaseClient.from('auftraege').select('*', { count: 'exact' }),
                    supabaseClient.from('abwesenheits_perioden').select('*', { count: 'exact' })
                ]);

                // Update stats
                document.getElementById('statMitarbeiter').textContent = mitarbeiterRes.count || 0;
                document.getElementById('statAuftraege').textContent = auftraegeRes.count || 0;
                document.getElementById('statAbwesenheiten').textContent = abwesenheitenRes.count || 0;

                console.log('‚úÖ Dashboard data loaded');
                
                // Load weather chart
                // Load weather for all locations
                loadWeatherForLocation('Oberglatt', 47.5207, 8.4919);
                loadWeatherForLocation('Schaffhausen', 47.6976, 8.6348);
                loadWeatherForLocation('Meilen', 47.2708, 8.6444);
                loadWeatherForLocation('Dietikon', 47.4014, 8.4008);
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function loadWeatherForLocation(locationName, lat, lon) {
            try {
                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,precipitation_probability,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Europe/Zurich&forecast_days=6`
                );
                
                if (!response.ok) throw new Error('API Fehler');
                
                const data = await response.json();
                
                document.getElementById(`weatherLoading${locationName}`).style.display = 'none';
                document.getElementById(`weatherWidget${locationName}`).style.display = 'block';
                
                // Store data globally for day switching
                window[`weatherData${locationName}`] = data;
                
                // Render today by default
                renderWeatherForDay(locationName, 0);
                
            } catch (error) {
                console.error(`Weather error ${locationName}:`, error);
                document.getElementById(`weatherLoading${locationName}`).innerHTML = '‚ö†Ô∏è Nicht verf√ºgbar';
            }
        }

        function renderWeatherForDay(locationName, dayIndex) {
            const data = window[`weatherData${locationName}`];
            
            // Weather icons mapping
            const getWeatherIcon = (code) => {
                if (code === 0) return '‚òÄÔ∏è';
                if (code <= 3) return '‚õÖ';
                if (code <= 48) return '‚òÅÔ∏è';
                if (code <= 67) return 'üåßÔ∏è';
                if (code <= 77) return 'üå®Ô∏è';
                if (code <= 82) return 'üåßÔ∏è';
                return '‚õàÔ∏è';
            };
            
            const getWeatherText = (code) => {
                if (code === 0) return 'Sonnig';
                if (code <= 3) return 'Bew√∂lkt';
                if (code <= 48) return 'Nebel';
                if (code <= 67) return 'Regen';
                if (code <= 77) return 'Schnee';
                if (code <= 82) return 'Regen';
                return 'Gewitter';
            };
            
            const date = new Date(data.daily.time[dayIndex]);
            const days = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
            const dayName = dayIndex === 0 ? 'Heute' : days[date.getDay()];
            
            let html = '';
            
            // SELECTED DAY - Compact horizontal view (12 hours, every 2 hours)
            html += `
                <div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border-radius: 10px; padding: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 10px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                        <div style="font-size: 32px;">
                            ${getWeatherIcon(data.daily.weather_code[dayIndex])}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 13px; font-weight: 600; opacity: 0.9; margin-bottom: 2px;">
                                ${dayName}
                            </div>
                            <div style="font-size: 24px; font-weight: 700;">
                                ${Math.round(data.daily.temperature_2m_max[dayIndex])}¬∞
                            </div>
                        </div>
                        <div style="text-align: right; font-size: 12px; opacity: 0.85;">
                            <div>‚Üë ${Math.round(data.daily.temperature_2m_max[dayIndex])}¬∞</div>
                            <div>‚Üì ${Math.round(data.daily.temperature_2m_min[dayIndex])}¬∞</div>
                        </div>
                    </div>
                    
                    <!-- Hourly forecast (12 hours, every 2h) - FULL WIDTH -->
                    <div style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 2px;">
            `;
            
            // Calculate hour offset for selected day
            const startHourOffset = dayIndex * 24;
            
            // Show 24 hours (every 2 hours = 12 intervals) - full day
            for (let i = 0; i < 24; i += 2) {
                const hourIndex = startHourOffset + i;
                if (hourIndex >= data.hourly.time.length) break;
                
                const temp = Math.round(data.hourly.temperature_2m[hourIndex]);
                const rain = data.hourly.precipitation_probability[hourIndex] || 0;
                const icon = getWeatherIcon(data.hourly.weather_code[hourIndex]);
                
                html += `
                    <div style="
                        background: rgba(255,255,255,0.12);
                        border-radius: 4px;
                        padding: 4px 1px;
                        text-align: center;
                        backdrop-filter: blur(10px);
                    ">
                        <div style="font-size: 8px; opacity: 0.8; margin-bottom: 2px;">
                            ${i}h
                        </div>
                        <div style="font-size: 14px; margin: 2px 0;">
                            ${icon}
                        </div>
                        <div style="font-size: 11px; font-weight: 600;">
                            ${temp}¬∞
                        </div>
                        <div style="font-size: 8px; opacity: 0.7; margin-top: 1px; min-height: 11px;">
                            ${rain > 20 ? `${rain}%` : '&nbsp;'}
                        </div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            // NEXT 5 DAYS - Super compact, clickable
            html += '<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px;">';
            
            for (let i = 0; i < 6; i++) {
                if (i === dayIndex) continue; // Skip selected day
                
                const date = new Date(data.daily.time[i]);
                const days = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
                const shortDay = i === 0 ? 'Heute' : days[date.getDay()];
                
                const icon = getWeatherIcon(data.daily.weather_code[i]);
                const maxTemp = Math.round(data.daily.temperature_2m_max[i]);
                const minTemp = Math.round(data.daily.temperature_2m_min[i]);
                const rain = data.daily.precipitation_probability_max[i] || 0;
                
                html += `
                    <div onclick="renderWeatherForDay('${locationName}', ${i})" style="
                        background: #f1f5f9;
                        border-radius: 6px;
                        padding: 6px 4px;
                        text-align: center;
                        cursor: pointer;
                        transition: all 0.2s;
                        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
                    " onmouseover="this.style.background='#e2e8f0'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='#f1f5f9'; this.style.transform='translateY(0)'">
                        <div style="font-size: 9px; font-weight: 600; margin-bottom: 3px; color: #64748b;">
                            ${shortDay}
                        </div>
                        <div style="font-size: 20px; margin: 3px 0;">
                            ${icon}
                        </div>
                        <div style="font-size: 13px; font-weight: 700; color: #1e293b;">
                            ${maxTemp}¬∞
                        </div>
                        <div style="font-size: 10px; color: #94a3b8;">
                            ${minTemp}¬∞
                        </div>
                        ${rain > 30 ? `
                            <div style="font-size: 8px; color: #3b82f6; margin-top: 1px;">
                                ${rain}%
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            
            html += '</div>';
            
            document.getElementById(`weatherWidget${locationName}`).innerHTML = html;
        }

        async function loadMitarbeiter() {
            try {
                const { data, error } = await supabaseClient
                    .from('mitarbeiter')
                    .select('*')
                    .order('nachname');

                if (error) throw error;

                allMitarbeiter = data || [];
                renderMitarbeiterTable();
                
                // Show/hide add button based on permissions
                const addBtn = document.getElementById('btnAddMitarbeiter');
                if (addBtn) {
                    addBtn.style.display = canEditPersonal() ? 'block' : 'none';
                }

                console.log('‚úÖ Mitarbeiter loaded:', allMitarbeiter.length);
            } catch (error) {
                console.error('Error loading mitarbeiter:', error);
            }
        }

        function renderMitarbeiterTable() {
            const container = document.getElementById('mitarbeiterTableContainer');

            if (allMitarbeiter.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <h3>Keine Mitarbeiter gefunden</h3>
                        <p style="margin-top: 8px;">Legen Sie Ihren ersten Mitarbeiter an!</p>
                    </div>
                `;
                return;
            }

            // Get filters
            const searchTerm = document.getElementById('searchMitarbeiter')?.value.toLowerCase() || '';
            const filterFunktion = document.getElementById('filterFunktion')?.value || '';
            const filterFiliale = document.getElementById('filterFiliale')?.value || '';

            // Apply filters
            let filtered = allMitarbeiter.filter(m => {
                const matchSearch = !searchTerm || 
                    m.vorname.toLowerCase().includes(searchTerm) ||
                    m.nachname.toLowerCase().includes(searchTerm) ||
                    (m.personal_id && m.personal_id.toLowerCase().includes(searchTerm));
                
                const matchFunktion = !filterFunktion || m.funktion === filterFunktion;
                const matchFiliale = !filterFiliale || m.filiale === filterFiliale;

                return matchSearch && matchFunktion && matchFiliale;
            });

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <h3>Keine Treffer</h3>
                        <p style="margin-top: 8px;">Versuchen Sie andere Filterkriterien</p>
                    </div>
                `;
                return;
            }

            const html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Filiale</th>
                            <th>Funktion</th>
                            <th>Vorname</th>
                            <th>Nachname</th>
                            <th>Personal-ID</th>
                            <th>Zugewiesen zu EC</th>
                            <th>Status</th>
                            ${canEditPersonal() || canDeletePersonal() ? '<th style="text-align: right;">Aktionen</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map(m => {
                            // Find assigned EC name
                            let assignedECName = '-';
                            if (m.assigned_ec) {
                                const ec = allMitarbeiter.find(e => e.id === m.assigned_ec);
                                if (ec) {
                                    assignedECName = `${ec.vorname} ${ec.nachname}`;
                                }
                            }

                            return `
                            <tr style="${!m.aktiv ? 'background: #f5f5f5; opacity: 0.7;' : ''}">
                                <td>
                                    <span class="badge badge-${m.filiale.toLowerCase()}">
                                        ${m.filiale}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge badge-${m.funktion.toLowerCase()}">
                                        ${m.funktion}
                                    </span>
                                </td>
                                <td>${m.vorname}</td>
                                <td><strong>${m.nachname}</strong></td>
                                <td>${m.personal_id || '-'}</td>
                                <td>${assignedECName}</td>
                                <td>
                                    ${m.aktiv ? 
                                        '<span style="color: var(--success); font-weight: 600;">‚úì Aktiv</span>' : 
                                        '<span style="color: var(--danger); font-weight: 600;">‚äò Inaktiv</span>'
                                    }
                                </td>
                                ${canEditPersonal() || canDeletePersonal() ? `
                                <td style="text-align: right;">
                                    ${canEditPersonal() ? `
                                        <button class="btn-icon" onclick="editMitarbeiterOpen(${m.id})" title="Bearbeiten">
                                            ‚úèÔ∏è
                                        </button>
                                        <button class="btn-icon ${m.aktiv ? '' : 'danger'}" onclick="toggleMitarbeiterStatus(${m.id})" title="${m.aktiv ? 'Deaktivieren' : 'Aktivieren'}">
                                            ${m.aktiv ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
                                        </button>
                                    ` : ''}
                                    ${canDeletePersonal() ? `
                                        <button class="btn-icon danger" onclick="deleteMitarbeiter(${m.id})" title="L√∂schen">
                                            üóëÔ∏è
                                        </button>
                                    ` : ''}
                                </td>
                                ` : ''}
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        function filterMitarbeiter() {
            renderMitarbeiterTable();
        }

        function resetFilters() {
            document.getElementById('searchMitarbeiter').value = '';
            document.getElementById('filterFunktion').value = '';
            document.getElementById('filterFiliale').value = '';
            renderMitarbeiterTable();
        }

        function openAddMitarbeiterDialog() {
            if (!canEditPersonal()) {
                alert('‚õî Keine Berechtigung um Mitarbeiter anzulegen');
                return;
            }

            document.getElementById('dialogTitle').textContent = 'Neue/-r Mitarbeiter/-in';
            document.getElementById('mitarbeiterForm').reset();
            document.getElementById('editMitarbeiterId').value = '';
            document.getElementById('inputAktiv').checked = true;
            
            // Load EC dropdown
            loadECDropdown();
            
            // Show dialog
            document.getElementById('mitarbeiterDialog').classList.add('show');
        }

        async function editMitarbeiterOpen(id) {
            if (!canEditPersonal()) {
                alert('‚õî Keine Berechtigung um Mitarbeiter zu bearbeiten');
                return;
            }

            const mitarbeiter = allMitarbeiter.find(m => m.id === id);
            if (!mitarbeiter) return;

            document.getElementById('dialogTitle').textContent = 'Mitarbeiter bearbeiten';
            document.getElementById('editMitarbeiterId').value = mitarbeiter.id;
            document.getElementById('inputVorname').value = mitarbeiter.vorname;
            document.getElementById('inputNachname').value = mitarbeiter.nachname;
            document.getElementById('inputPersonalId').value = mitarbeiter.personal_id || '';
            document.getElementById('inputFunktion').value = mitarbeiter.funktion;
            document.getElementById('inputFiliale').value = mitarbeiter.filiale;
            document.getElementById('inputTeamgroesse').value = mitarbeiter.teamgroesse || 1;
            document.getElementById('inputAktiv').checked = mitarbeiter.aktiv;

            // Check if system user exists
            try {
                const { data: systemUser } = await supabaseClient
                    .from('system_users')
                    .select('*')
                    .eq('mitarbeiter_id', mitarbeiter.id)
                    .single();

                if (systemUser) {
                    document.getElementById('inputSystemZugang').checked = true;
                    document.getElementById('existingSystemUserId').value = systemUser.id;
                    document.getElementById('inputSystemRolle').value = systemUser.role;
                    document.getElementById('inputUsername').value = systemUser.username;
                    document.getElementById('inputPassword').value = systemUser.password;
                    toggleSystemZugang();
                } else {
                    document.getElementById('inputSystemZugang').checked = false;
                    document.getElementById('existingSystemUserId').value = '';
                    toggleSystemZugang();
                }
            } catch (error) {
                // No system user found - that's ok
                document.getElementById('inputSystemZugang').checked = false;
                document.getElementById('existingSystemUserId').value = '';
            }

            // Load EC dropdown and set value
            loadECDropdown();
            if (mitarbeiter.assigned_ec) {
                document.getElementById('inputZugewiesen').value = mitarbeiter.assigned_ec;
            }

            // Show/hide conditional fields
            handleFunktionChange();

            // Show dialog
            document.getElementById('mitarbeiterDialog').classList.add('show');
        }

        function closeMitarbeiterDialog() {
            document.getElementById('mitarbeiterDialog').classList.remove('show');
        }

        function handleFunktionChange() {
            const funktion = document.getElementById('inputFunktion').value;
            const teamgroesseGroup = document.getElementById('teamgroesseGroup');
            const zugewiesenGroup = document.getElementById('zugewiesenGroup');

            if (funktion === 'EC') {
                teamgroesseGroup.style.display = 'block';
                zugewiesenGroup.style.display = 'none';
                
                // Suggest EC role for system access
                if (document.getElementById('inputSystemZugang').checked) {
                    document.getElementById('inputSystemRolle').value = 'equipenchef';
                }
            } else if (funktion === 'MA') {
                teamgroesseGroup.style.display = 'none';
                zugewiesenGroup.style.display = 'block';
            } else {
                teamgroesseGroup.style.display = 'none';
                zugewiesenGroup.style.display = 'none';
            }
        }

        function toggleSystemZugang() {
            const checked = document.getElementById('inputSystemZugang').checked;
            const fields = document.getElementById('systemZugangFields');
            
            if (checked) {
                fields.style.display = 'block';
                generateUsername();
                
                // Auto-select role based on funktion
                const funktion = document.getElementById('inputFunktion').value;
                if (funktion === 'EC') {
                    document.getElementById('inputSystemRolle').value = 'equipenchef';
                }
            } else {
                fields.style.display = 'none';
            }
        }

        function generateUsername() {
            const vorname = document.getElementById('inputVorname').value.trim().toLowerCase();
            const nachname = document.getElementById('inputNachname').value.trim().toLowerCase();
            
            if (vorname && nachname) {
                // Remove umlauts and special chars
                const username = (vorname + '.' + nachname)
                    .replace(/√§/g, 'ae')
                    .replace(/√∂/g, 'oe')
                    .replace(/√º/g, 'ue')
                    .replace(/√ü/g, 'ss')
                    .replace(/[^a-z.]/g, '');
                
                document.getElementById('inputUsername').value = username;
                checkUsernameAvailability();
            }
        }

        let usernameCheckTimeout;
        async function checkUsernameAvailability() {
            clearTimeout(usernameCheckTimeout);
            
            const username = document.getElementById('inputUsername').value.trim();
            const statusEl = document.getElementById('usernameStatus');
            const editingUserId = document.getElementById('existingSystemUserId').value;

            if (!username) {
                statusEl.innerHTML = '';
                return;
            }

            // Show checking indicator
            statusEl.innerHTML = '<span style="color: var(--text-gray);">üîÑ Pr√ºfe Verf√ºgbarkeit...</span>';

            // Debounce
            usernameCheckTimeout = setTimeout(async () => {
                try {
                    const { data, error } = await supabaseClient
                        .from('system_users')
                        .select('id')
                        .eq('username', username);

                    if (error) throw error;

                    // If editing and username belongs to current user, it's ok
                    if (editingUserId && data.length === 1 && data[0].id === parseInt(editingUserId)) {
                        statusEl.innerHTML = '<span style="color: var(--success);">‚úÖ Ihr aktueller Benutzername</span>';
                        return;
                    }

                    if (data && data.length > 0) {
                        // Username taken - suggest alternative
                        const suggestion = await suggestAlternativeUsername(username);
                        statusEl.innerHTML = `
                            <span style="color: var(--danger);">‚ùå Bereits vergeben</span>
                            <button type="button" onclick="document.getElementById('inputUsername').value='${suggestion}'; checkUsernameAvailability();" 
                                    style="margin-left: 8px; padding: 2px 8px; border: 1px solid var(--primary); background: white; color: var(--primary); border-radius: 4px; font-size: 11px; cursor: pointer;">
                                "${suggestion}" verwenden
                            </button>
                        `;
                    } else {
                        statusEl.innerHTML = '<span style="color: var(--success);">‚úÖ Verf√ºgbar</span>';
                    }
                } catch (error) {
                    console.error('Username check error:', error);
                    statusEl.innerHTML = '<span style="color: var(--text-gray);">Pr√ºfung fehlgeschlagen</span>';
                }
            }, 500);
        }

        async function suggestAlternativeUsername(baseUsername) {
            // Try username2, username3, etc.
            for (let i = 2; i <= 99; i++) {
                const candidate = baseUsername + i;
                
                const { data } = await supabaseClient
                    .from('system_users')
                    .select('id')
                    .eq('username', candidate);

                if (!data || data.length === 0) {
                    return candidate;
                }
            }
            
            // Fallback: add timestamp
            return baseUsername + '_' + Date.now();
        }

        // Auto-generate username when name changes
        document.addEventListener('DOMContentLoaded', () => {
            const vornameInput = document.getElementById('inputVorname');
            const nachnameInput = document.getElementById('inputNachname');
            
            if (vornameInput) {
                vornameInput.addEventListener('blur', () => {
                    if (document.getElementById('inputSystemZugang').checked) {
                        generateUsername();
                    }
                });
            }
            
            if (nachnameInput) {
                nachnameInput.addEventListener('blur', () => {
                    if (document.getElementById('inputSystemZugang').checked) {
                        generateUsername();
                    }
                });
            }
        });

        function loadECDropdown() {
            const select = document.getElementById('inputZugewiesen');
            const ecs = allMitarbeiter.filter(m => m.funktion === 'EC' && m.aktiv);

            select.innerHTML = '<option value="">Nicht zugewiesen</option>';
            ecs.forEach(ec => {
                const option = document.createElement('option');
                option.value = ec.id;
                option.textContent = `${ec.vorname} ${ec.nachname}`;
                select.appendChild(option);
            });
        }

        async function saveMitarbeiter(event) {
            event.preventDefault();

            const editId = document.getElementById('editMitarbeiterId').value;
            const vorname = document.getElementById('inputVorname').value.trim();
            const nachname = document.getElementById('inputNachname').value.trim();
            const personalId = document.getElementById('inputPersonalId').value.trim();
            const funktion = document.getElementById('inputFunktion').value;
            const filiale = document.getElementById('inputFiliale').value;
            const teamgroesse = document.getElementById('inputTeamgroesse').value;
            const zugewiesen = document.getElementById('inputZugewiesen').value;
            const aktiv = document.getElementById('inputAktiv').checked;

            // System access fields
            const systemZugang = document.getElementById('inputSystemZugang').checked;
            const systemRolle = document.getElementById('inputSystemRolle').value;
            const username = document.getElementById('inputUsername').value.trim();
            const password = document.getElementById('inputPassword').value.trim();

            // Validation for system access
            if (systemZugang) {
                if (!systemRolle || !username || !password) {
                    alert('Bitte f√ºllen Sie alle System-Zugang Felder aus!');
                    return;
                }

                // Check username availability one more time before saving
                const existingUserId = document.getElementById('existingSystemUserId').value;
                const { data: existingUsers } = await supabaseClient
                    .from('system_users')
                    .select('id')
                    .eq('username', username);

                if (existingUsers && existingUsers.length > 0) {
                    // If editing and it's the same user, that's ok
                    if (!existingUserId || existingUsers[0].id !== parseInt(existingUserId)) {
                        alert(`‚ùå Benutzername "${username}" ist bereits vergeben!\n\nBitte w√§hlen Sie einen anderen Namen.`);
                        return;
                    }
                }
            }

            try {
                const mitarbeiterId = editId ? parseInt(editId) : Date.now();

                const mitarbeiterData = {
                    vorname,
                    nachname,
                    personal_id: personalId || null,
                    funktion,
                    filiale,
                    aktiv,
                    teamgroesse: funktion === 'EC' ? parseInt(teamgroesse) : null,
                    assigned_ec: funktion === 'MA' && zugewiesen ? parseInt(zugewiesen) : null
                };

                if (editId) {
                    // Update mitarbeiter
                    const { error } = await supabaseClient
                        .from('mitarbeiter')
                        .update(mitarbeiterData)
                        .eq('id', mitarbeiterId);

                    if (error) throw error;
                    console.log('‚úÖ Mitarbeiter updated');
                } else {
                    // Insert new mitarbeiter
                    mitarbeiterData.id = mitarbeiterId;
                    const { error } = await supabaseClient
                        .from('mitarbeiter')
                        .insert([mitarbeiterData]);

                    if (error) throw error;
                    console.log('‚úÖ Mitarbeiter created');
                }

                // Handle system user
                if (systemZugang) {
                    const existingUserId = document.getElementById('existingSystemUserId').value;

                    const systemUserData = {
                        username,
                        password,
                        name: `${vorname} ${nachname}`,
                        role: systemRolle,
                        active: aktiv,
                        mitarbeiter_id: mitarbeiterId
                    };

                    if (existingUserId) {
                        // Update existing system user
                        const { error } = await supabaseClient
                            .from('system_users')
                            .update(systemUserData)
                            .eq('id', parseInt(existingUserId));

                        if (error) throw error;
                        console.log('‚úÖ System user updated');
                    } else {
                        // Check if username already exists
                        const { data: existingUser } = await supabaseClient
                            .from('system_users')
                            .select('id')
                            .eq('username', username)
                            .single();

                        if (existingUser) {
                            throw new Error(`Benutzername "${username}" existiert bereits!`);
                        }

                        // Create new system user
                        const { error } = await supabaseClient
                            .from('system_users')
                            .insert([systemUserData]);

                        if (error) throw error;
                        console.log('‚úÖ System user created');
                    }
                }

                closeMitarbeiterDialog();
                await loadMitarbeiter();
                await loadDashboardData();

                if (systemZugang && !editId) {
                    alert(`‚úÖ Mitarbeiter erfasst!\n\nLogin-Daten:\nUsername: ${username}\nPasswort: ${password}\n\nBitte notieren und dem Mitarbeiter mitteilen.`);
                }

            } catch (error) {
                console.error('Error saving:', error);
                alert('Fehler beim Speichern: ' + error.message);
            }
        }

        async function toggleMitarbeiterStatus(id) {
            if (!canEditPersonal()) {
                alert('‚õî Keine Berechtigung um Mitarbeiter zu deaktivieren');
                return;
            }

            const mitarbeiter = allMitarbeiter.find(m => m.id === id);
            if (!mitarbeiter) return;

            const newStatus = !mitarbeiter.aktiv;
            const action = newStatus ? 'aktivieren' : 'deaktivieren';

            if (!confirm(`${mitarbeiter.vorname} ${mitarbeiter.nachname} wirklich ${action}?`)) {
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('mitarbeiter')
                    .update({ aktiv: newStatus })
                    .eq('id', id);

                if (error) throw error;

                console.log(`‚úÖ Mitarbeiter ${action}d`);
                await loadMitarbeiter();

            } catch (error) {
                console.error('Error toggling status:', error);
                alert('Fehler: ' + error.message);
            }
        }

        async function deleteMitarbeiter(id) {
            if (!canDeletePersonal()) {
                alert('‚õî Keine Berechtigung um Mitarbeiter zu l√∂schen');
                return;
            }

            const mitarbeiter = allMitarbeiter.find(m => m.id === id);
            if (!mitarbeiter) return;

            if (!confirm(`${mitarbeiter.vorname} ${mitarbeiter.nachname} wirklich l√∂schen?`)) {
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('mitarbeiter')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                console.log('‚úÖ Mitarbeiter deleted');
                await loadMitarbeiter();
                await loadDashboardData();

            } catch (error) {
                console.error('Error deleting:', error);
                alert('Fehler beim L√∂schen: ' + error.message);
            }
        }
    </script>

    <style>
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
        }

        .modal.show {
            display: block;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin: 0;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-light);
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--border);
        }

        .modal-body {
            padding: 24px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border);
        }

        .btn-secondary {
            background: var(--bg-light);
            color: var(--text-dark);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }
    </style>

    <!-- Berechtigungen Modal -->
    <div id="berechtigungenModal" class="modal">
        <div class="modal-overlay" onclick="closeBerechtigungen()"></div>
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>Rollen & Berechtigungen</h2>
                <button class="modal-close" onclick="closeBerechtigungen()">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="stellvertreterSection" style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; margin-bottom: 24px; display: none;">
                    <h3 style="margin: 0 0 12px 0; color: var(--primary); display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 24px;">üë•</span>
                        Admin-Stellvertreter
                    </h3>
                    <p style="color: var(--text-gray); font-size: 14px; margin: 0 0 16px 0;">
                        W√§hlen Sie Benutzer aus, die <strong>tempor√§r volle Admin-Rechte</strong> erhalten sollen.
                        Diese k√∂nnen ebenfalls Berechtigungen verwalten.
                    </p>
                    <div id="stellvertreterContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 12px;">
                        <!-- Will be loaded dynamically -->
                    </div>
                </div>

                <h3 style="margin: 0 0 8px 0; color: var(--primary);">Rollenberechtigungen</h3>
                <p style="color: var(--text-gray); margin-bottom: 24px; font-size: 14px;">
                    Definieren Sie welche Rolle welche Bereiche sehen und bearbeiten darf.
                    <strong>√Ñnderungen werden sofort wirksam.</strong>
                </p>
                <div id="rolesPermissionsModalContainer"></div>
            </div>
        </div>
    </div>

    <!-- Abwesenheit Dialog -->
    <div id="abwesenheitDialog" class="modal">
        <div class="modal-overlay" onclick="closeAbwesenheitDialog()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="abwesenheitDialogTitle">Neue Abwesenheit</h2>
                <button class="modal-close" onclick="closeAbwesenheitDialog()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="abwesenheitForm" onsubmit="saveAbwesenheit(event); return false;">
                    <div class="form-group">
                        <label for="inputAbwMitarbeiter">Mitarbeiter *</label>
                        <select id="inputAbwMitarbeiter" required>
                            <option value="">Bitte w√§hlen...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="inputAbwTyp">Art der Abwesenheit *</label>
                        <select id="inputAbwTyp" required>
                            <option value="">Bitte w√§hlen...</option>
                            <option value="FE">FE - Ferien</option>
                            <option value="KO">KO - Kompensation</option>
                            <option value="KR">KR - Krankheit</option>
                            <option value="UF">UF - Unfall</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="inputAbwVon">Von (Startdatum) *</label>
                            <input type="date" id="inputAbwVon" required onchange="onAbwVonChange()">
                        </div>
                        <div class="form-group">
                            <label for="inputAbwBis">Bis (Enddatum) *</label>
                            <input type="date" id="inputAbwBis" required onchange="calculateAbwTage()">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Anzahl Tage</label>
                        <input type="text" id="inputAbwTage" readonly style="background: var(--bg-light);">
                    </div>

                    <input type="hidden" id="editAbwesenheitId">
                    <input type="hidden" id="clickedDate">

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeAbwesenheitDialog()">
                            Abbrechen
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Speichern
                        </button>
                        <button type="button" class="btn" style="background: var(--success); color: white;" id="btnKannArbeiten" onclick="kannArbeiten()" style="display: none;">
                            ‚úì Kann arbeiten
                        </button>
                        <button type="button" class="btn" style="background: var(--danger); color: white; margin-left: auto;" id="btnDeleteAbwesenheit" onclick="deleteAbwesenheit()" style="display: none;">
                            L√∂schen
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Betriebsferien Dialog -->
    <div id="betriebsferienDialog" class="modal">
        <div class="modal-overlay" onclick="closeBetriebsferienDialog()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Betriebsferien erfassen</h2>
                <button class="modal-close" onclick="closeBetriebsferienDialog()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="betriebsferienForm" onsubmit="saveBetriebsferien(event); return false;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="inputBfVon">Von (Startdatum) *</label>
                            <input type="date" id="inputBfVon" required onchange="onBfVonChange()">
                        </div>
                        <div class="form-group">
                            <label for="inputBfBis">Bis (Enddatum) *</label>
                            <input type="date" id="inputBfBis" required onchange="calculateBfTage()">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Anzahl Tage</label>
                        <input type="text" id="inputBfTage" readonly style="background: var(--bg-light);">
                    </div>

                    <div class="form-group">
                        <label>Betrifft *</label>
                        <div style="display: flex; gap: 20px; padding: 8px 0;">
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 14px;">
                                <input type="checkbox" id="bfVerwaltung" value="VW" onchange="updateBfCount()" style="width: 16px; height: 16px;">
                                <span>Verwaltung</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 14px;">
                                <input type="checkbox" id="bfFilialen" value="filialen" onchange="updateBfCount()" style="width: 16px; height: 16px;">
                                <span>Filialbetriebe</span>
                            </label>
                        </div>
                        <small id="bfMitarbeiterCount" style="color: var(--text-gray); font-size: 12px; display: block; margin-top: 4px;">
                            Keine Mitarbeiter ausgew√§hlt
                        </small>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeBetriebsferienDialog()">
                            Abbrechen
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Betriebsferien erstellen
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Feiertag Dialog -->
    <div id="feiertagDialog" class="modal">
        <div class="modal-overlay" onclick="closeFeiertagDialog()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Feiertage erfassen</h2>
                <button class="modal-close" onclick="closeFeiertagDialog()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="feiertagForm" onsubmit="saveFeiertag(event); return false;">
                    <div class="form-group">
                        <label for="inputFtName">Name des Feiertags *</label>
                        <input type="text" id="inputFtName" required placeholder="z.B. Weihnachten, Neujahr, Berchtoldstag">
                        <small style="color: var(--text-gray); font-size: 12px; display: block; margin-top: 4px;">
                            Dieser Name wird nur f√ºr die Meldung verwendet, nicht gespeichert
                        </small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="inputFtVon">Von (Startdatum) *</label>
                            <input type="date" id="inputFtVon" required onchange="onFtVonChange()">
                        </div>
                        <div class="form-group">
                            <label for="inputFtBis">Bis (Enddatum) *</label>
                            <input type="date" id="inputFtBis" required onchange="calculateFtTage()">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Anzahl Tage</label>
                        <input type="text" id="inputFtTage" readonly style="background: var(--bg-light);">
                    </div>

                    <div class="form-group">
                        <label>Filialen (abw√§hlen = Feiertag gilt NICHT) *</label>
                        <div style="padding: 12px; background: var(--bg-light); border-radius: 8px;">
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;">
                                    <input type="checkbox" class="ft-filiale-checkbox" value="VW" onchange="updateFtCount()" checked style="width: 14px; height: 14px;">
                                    <span>VW</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;">
                                    <input type="checkbox" class="ft-filiale-checkbox" value="AG" onchange="updateFtCount()" checked style="width: 14px; height: 14px;">
                                    <span>AG</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;">
                                    <input type="checkbox" class="ft-filiale-checkbox" value="WS" onchange="updateFtCount()" checked style="width: 14px; height: 14px;">
                                    <span>WS</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;">
                                    <input type="checkbox" class="ft-filiale-checkbox" value="GL" onchange="updateFtCount()" checked style="width: 14px; height: 14px;">
                                    <span>GL</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;">
                                    <input type="checkbox" class="ft-filiale-checkbox" value="GR" onchange="updateFtCount()" checked style="width: 14px; height: 14px;">
                                    <span>GR</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;">
                                    <input type="checkbox" class="ft-filiale-checkbox" value="SG" onchange="updateFtCount()" checked style="width: 14px; height: 14px;">
                                    <span>SG</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;">
                                    <input type="checkbox" class="ft-filiale-checkbox" value="ZH" onchange="updateFtCount()" checked style="width: 14px; height: 14px;">
                                    <span>ZH</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;">
                                    <input type="checkbox" class="ft-filiale-checkbox" value="ZS" onchange="updateFtCount()" checked style="width: 14px; height: 14px;">
                                    <span>ZS</span>
                                </label>
                            </div>
                        </div>
                        <small id="ftMitarbeiterCount" style="color: var(--text-gray); font-size: 12px; display: block; margin-top: 8px;">
                            Wird berechnet...
                        </small>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="ftJaehrlich" style="width: 16px; height: 16px;">
                            <span>üîÅ J√§hrlich wiederkehrend</span>
                        </label>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeFeiertagDialog()">
                            Abbrechen
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Feiertag erstellen
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- BF/FT Verwaltung Dialog -->
    <div id="loeschenDialog" class="modal">
        <div class="modal-overlay" onclick="closeLoeschenDialog()"></div>
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Betriebsferien / Feiertage verwalten</h2>
                <button class="modal-close" onclick="closeLoeschenDialog()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="inputVerwaltenTyp">Typ ausw√§hlen *</label>
                    <select id="inputVerwaltenTyp" onchange="loadBfFtList()">
                        <option value="">Bitte w√§hlen...</option>
                        <option value="BF">Betriebsferien (BF)</option>
                        <option value="FT">Feiertage (FT)</option>
                    </select>
                </div>

                <div id="bfFtListContainer" style="display: none;">
                    <p style="color: var(--text-gray); font-size: 13px; margin-bottom: 12px;">
                        Zeigt alle zuk√ºnftigen Eintr√§ge. J√§hrlich wiederkehrende Feiertage werden zusammengefasst.
                    </p>
                    <div id="bfFtList" style="max-height: 400px; overflow-y: auto;">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeLoeschenDialog()">
                        Schlie√üen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- BF/FT Bearbeiten Dialog -->
    <div id="editBfFtDialog" class="modal">
        <div class="modal-overlay" onclick="closeEditBfFtDialog()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="editBfFtTitle">Eintrag bearbeiten</h2>
                <button class="modal-close" onclick="closeEditBfFtDialog()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="editBfFtForm" onsubmit="saveEditBfFt(event); return false;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="inputEditVon">Von (Startdatum) *</label>
                            <input type="date" id="inputEditVon" required>
                        </div>
                        <div class="form-group">
                            <label for="inputEditBis">Bis (Enddatum) *</label>
                            <input type="date" id="inputEditBis" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Filialen *</label>
                        <div style="padding: 12px; background: var(--bg-light); border-radius: 8px;">
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;">
                                    <input type="checkbox" class="edit-filiale-checkbox" value="VW" style="width: 14px; height: 14px;">
                                    <span>VW</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;">
                                    <input type="checkbox" class="edit-filiale-checkbox" value="AG" style="width: 14px; height: 14px;">
                                    <span>AG</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;">
                                    <input type="checkbox" class="edit-filiale-checkbox" value="BO" style="width: 14px; height: 14px;">
                                    <span>BO</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;">
                                    <input type="checkbox" class="edit-filiale-checkbox" value="GL" style="width: 14px; height: 14px;">
                                    <span>GL</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;">
                                    <input type="checkbox" class="edit-filiale-checkbox" value="GR" style="width: 14px; height: 14px;">
                                    <span>GR</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;">
                                    <input type="checkbox" class="edit-filiale-checkbox" value="SG" style="width: 14px; height: 14px;">
                                    <span>SG</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;">
                                    <input type="checkbox" class="edit-filiale-checkbox" value="ZH" style="width: 14px; height: 14px;">
                                    <span>ZH</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px;">
                                    <input type="checkbox" class="edit-filiale-checkbox" value="ZS" style="width: 14px; height: 14px;">
                                    <span>ZS</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" id="editBfFtEntries">
                    <input type="hidden" id="editBfFtTyp">
                    <input type="hidden" id="editBfFtIsRecurring">

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeEditBfFtDialog()">
                            Abbrechen
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Speichern
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Kann Arbeiten Dialog -->
    <div id="kannArbeitenDialog" class="modal">
        <div class="modal-overlay" onclick="closeKannArbeitenDialog()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Kann arbeiten w√§hrend <span id="kannArbTypName"></span></h2>
                <button class="modal-close" onclick="closeKannArbeitenDialog()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="kannArbeitenForm" onsubmit="saveKannArbeiten(event); return false;">
                    <p style="color: var(--text-gray); margin-bottom: 16px;">
                        <span id="kannArbInfo"></span>
                    </p>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="inputKannVon">Von (Startdatum) *</label>
                            <input type="date" id="inputKannVon" required onchange="onKannVonChange()">
                        </div>
                        <div class="form-group">
                            <label for="inputKannBis">Bis (Enddatum) *</label>
                            <input type="date" id="inputKannBis" required onchange="calculateKannTage()">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Anzahl Tage</label>
                        <input type="text" id="inputKannTage" readonly style="background: var(--bg-light);">
                    </div>

                    <input type="hidden" id="kannArbMitarbeiterId">
                    <input type="hidden" id="kannArbOriginalVon">
                    <input type="hidden" id="kannArbOriginalBis">

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeKannArbeitenDialog()">
                            Abbrechen
                        </button>
                        <button type="submit" class="btn btn-primary">
                            ARB-Eintrag erstellen
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Mitarbeiter Dialog -->
    <div id="mitarbeiterDialog" class="modal">
        <div class="modal-overlay" onclick="closeMitarbeiterDialog()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="dialogTitle">Neuer Mitarbeiter</h2>
                <button class="modal-close" onclick="closeMitarbeiterDialog()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="mitarbeiterForm" onsubmit="saveMitarbeiter(event); return false;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="inputVorname">Vorname *</label>
                            <input type="text" id="inputVorname" required>
                        </div>
                        <div class="form-group">
                            <label for="inputNachname">Nachname *</label>
                            <input type="text" id="inputNachname" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="inputPersonalId">Personal-ID</label>
                            <input type="text" id="inputPersonalId">
                        </div>
                        <div class="form-group">
                            <label for="inputFunktion">Funktion *</label>
                            <select id="inputFunktion" required onchange="handleFunktionChange()">
                                <option value="">Bitte w√§hlen...</option>
                                <option value="GL">GL - Gesch√§ftsleitung</option>
                                <option value="FL">FL - Filialleiter</option>
                                <option value="DI">DI - Disponent</option>
                                <option value="EC">EC - Equipenchef</option>
                                <option value="PL">PL - Projektleiter</option>
                                <option value="TKB">TKB - Technischer Kundenberater</option>
                                <option value="MA">MA - Markierer</option>
                                <option value="WS">WS - Werkstatt</option>
                                <option value="BO">BO - Backoffice</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="inputFiliale">Filiale *</label>
                            <select id="inputFiliale" required>
                                <option value="">Bitte w√§hlen...</option>
                                <option value="VW">Verwaltung</option>
                                <option value="AG">Aargau</option>
                                <option value="BO">Backoffice</option>
                                <option value="GL">Glarus</option>
                                <option value="GR">Graub√ºnden</option>
                                <option value="SG">St. Gallen</option>
                                <option value="ZH">Z√ºrich</option>
                                <option value="ZS">Zentralschweiz</option>
                                <option value="WS">Werkstatt</option>
                            </select>
                        </div>
                        <div class="form-group" id="teamgroesseGroup" style="display: none;">
                            <label for="inputTeamgroesse">Teamgr√∂√üe</label>
                            <input type="number" id="inputTeamgroesse" min="1" max="10" value="1">
                        </div>
                    </div>

                    <div class="form-group" id="zugewiesenGroup" style="display: none;">
                        <label for="inputZugewiesen">Zugewiesen zu EC</label>
                        <select id="inputZugewiesen">
                            <option value="">Nicht zugewiesen</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="inputAktiv" checked>
                            <span>Mitarbeiter ist aktiv</span>
                        </label>
                    </div>

                    <div style="margin: 24px 0; padding-top: 24px; border-top: 2px solid var(--border);">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="inputSystemZugang" onchange="toggleSystemZugang()">
                                <span><strong>System-Zugang gew√§hren</strong> (Mitarbeiter kann sich einloggen)</span>
                            </label>
                        </div>

                        <div id="systemZugangFields" style="display: none; padding: 16px; background: var(--bg-light); border-radius: 8px; margin-top: 16px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="inputSystemRolle">Rolle im System *</label>
                                    <select id="inputSystemRolle">
                                        <option value="">Bitte w√§hlen...</option>
                                        <option value="equipenchef">EC - Equipenchef (Tagesprogramm mobil)</option>
                                        <option value="tkb">TKB - Technischer Kundenberater</option>
                                        <option value="disponent">D - Disponent</option>
                                        <option value="backoffice">BO - Backoffice (nur ansehen)</option>
                                        <option value="geschaeftsleitung">GL - Gesch√§ftsleitung</option>
                                        <option value="admin">AD - Administrator</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="inputUsername">Benutzername *</label>
                                    <input type="text" id="inputUsername" placeholder="vorname.nachname" oninput="checkUsernameAvailability()">
                                    <div id="usernameStatus" style="margin-top: 4px; font-size: 12px;"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="inputPassword">Passwort *</label>
                                <input type="text" id="inputPassword" placeholder="Initiales Passwort festlegen">
                                <small style="color: var(--text-gray); font-size: 12px;">Mitarbeiter kann es sp√§ter √§ndern</small>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" id="editMitarbeiterId">
                    <input type="hidden" id="existingSystemUserId">

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeMitarbeiterDialog()">
                            Abbrechen
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Speichern
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Mein Profil Dialog -->
    <div id="meinProfilDialog" class="modal">
        <div class="modal-overlay" onclick="closeMeinProfil()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>Mein Profil</h2>
                <button class="modal-close" onclick="closeMeinProfil()">‚úï</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; align-items: center; gap: 24px; margin-bottom: 24px;">
                    <div id="profilFotoPreview" style="width: 100px; height: 100px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-size: 36px; font-weight: 700; overflow: hidden; flex-shrink: 0;">
                        MF
                    </div>
                    <div style="flex: 1;">
                        <input type="file" id="profilFotoInput" accept="image/*" style="display: none;" onchange="handleProfilFotoChange(event)">
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <button class="btn btn-secondary" onclick="document.getElementById('profilFotoInput').click()" style="font-size: 13px; padding: 8px 16px;">
                                üì∑ Foto √§ndern
                            </button>
                            <button class="btn btn-secondary" onclick="removeProfilFoto()" id="btnRemoveFoto" style="display: none; font-size: 13px; padding: 8px 16px;">
                                üóëÔ∏è Entfernen
                            </button>
                        </div>
                        <p style="color: var(--text-gray); font-size: 12px; margin: 0;">
                            Empfohlen: Quadratisches Bild, max. 2 MB
                        </p>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeMeinProfil()">
                        Abbrechen
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveMeinProfil()">
                        Speichern
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Foto Cropper Dialog -->
    <div id="fotoCropperDialog" class="modal">
        <div class="modal-overlay"></div>
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Foto zuschneiden</h2>
                <button class="modal-close" onclick="closeFotoCropper()">‚úï</button>
            </div>
            <div class="modal-body">
                <div style="position: relative; width: 300px; height: 300px; margin: 0 auto 16px; border: 2px solid var(--border); border-radius: 8px; overflow: hidden; background: #f5f5f5;">
                    <canvas id="cropCanvas" width="300" height="300" style="cursor: move; display: block;"></canvas>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; border: 3px solid white; border-radius: 50%; pointer-events: none; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);"></div>
                </div>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 600;">Zoom</label>
                    <input type="range" id="zoomSlider" min="50" max="300" value="100" style="width: 100%;" oninput="updateCropZoom()">
                </div>
                
                <p style="text-align: center; color: var(--text-gray); font-size: 12px;">
                    Ziehen Sie das Bild um es zu positionieren
                </p>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeFotoCropper()">
                        Abbrechen
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveCroppedFoto()">
                        √úbernehmen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Mein Profil Functions - Make globally available
    window.openMeinProfil = async function() {
        document.getElementById('userDropdown').classList.remove('show');
        
        // Load current user's mitarbeiter data by name
        try {
            const { data: mitarbeiter } = await supabaseClient
                .from('mitarbeiter')
                .select('id, foto')
                .ilike('vorname', currentUser.name.split(' ')[0])
                .ilike('nachname', currentUser.name.split(' ').slice(1).join(' '))
                .single();
            
            // Store mitarbeiter ID for later use
            currentUser.mitarbeiterId = mitarbeiter?.id;
            
            const preview = document.getElementById('profilFotoPreview');
            if (mitarbeiter?.foto) {
                preview.innerHTML = `<img src="${mitarbeiter.foto}" style="width: 100%; height: 100%; object-fit: cover;">`;
                document.getElementById('btnRemoveFoto').style.display = 'inline-block';
            } else {
                preview.textContent = getInitials(currentUser.name);
                preview.style.background = 'var(--primary)';
                document.getElementById('btnRemoveFoto').style.display = 'none';
            }
        } catch (error) {
            console.error('Error loading foto:', error);
            alert('‚ö†Ô∏è Kein Mitarbeiter-Eintrag gefunden f√ºr: ' + currentUser.name);
        }
        
        document.getElementById('meinProfilDialog').classList.add('show');
    };

    window.closeMeinProfil = function() {
        document.getElementById('meinProfilDialog').classList.remove('show');
    };

    window.saveMeinProfil = function() {
        // Foto is already saved by cropper, just close
        closeMeinProfil();
    };

    window.updateHeaderAvatar = async function() {
        try {
            const { data: mitarbeiter } = await supabaseClient
                .from('mitarbeiter')
                .select('foto')
                .ilike('vorname', currentUser.name.split(' ')[0])
                .ilike('nachname', currentUser.name.split(' ').slice(1).join(' '))
                .single();
            
            const avatar = document.getElementById('userAvatar');
            if (mitarbeiter?.foto) {
                avatar.innerHTML = `<img src="${mitarbeiter.foto}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            } else {
                avatar.textContent = getInitials(currentUser.name);
                avatar.style.background = '#4f46e5';
            }
        } catch (error) {
            console.error('Error updating avatar:', error);
        }
    };

    // Cropper variables
    let cropImage = null;
    let cropScale = 100;
    let cropX = 0;
    let cropY = 0;
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;

    window.handleProfilFotoChange = async function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!currentUser.mitarbeiterId) {
            alert('‚ö†Ô∏è Kein Mitarbeiter-Eintrag gefunden');
            return;
        }
        
        // Check file size (max 2MB)
        if (file.size > 2 * 1024 * 1024) {
            alert('‚ö†Ô∏è Datei zu gro√ü! Maximale Gr√∂√üe: 2 MB');
            return;
        }
        
        // Check file type
        if (!file.type.startsWith('image/')) {
            alert('‚ö†Ô∏è Bitte w√§hlen Sie ein Bild');
            return;
        }
        
        // Load image into cropper
        const reader = new FileReader();
        reader.onload = (e) => {
            cropImage = new Image();
            cropImage.onload = () => {
                // Reset cropper
                cropScale = 100;
                cropX = 0;
                cropY = 0;
                document.getElementById('zoomSlider').value = 100;
                
                // Open cropper
                document.getElementById('fotoCropperDialog').classList.add('show');
                setupCropCanvas();
            };
            cropImage.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    window.setupCropCanvas = function() {
        const canvas = document.getElementById('cropCanvas');
        canvas.onmousedown = startDrag;
        canvas.onmousemove = drag;
        canvas.onmouseup = endDrag;
        canvas.onmouseleave = endDrag;
        drawCropCanvas();
    }

    window.drawCropCanvas = function() {
        const canvas = document.getElementById('cropCanvas');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, 300, 300);
        
        if (!cropImage) return;
        
        const scale = cropScale / 100;
        const width = cropImage.width * scale;
        const height = cropImage.height * scale;
        ctx.drawImage(cropImage, cropX, cropY, width, height);
    }

    window.startDrag = function(e) {
        isDragging = true;
        const rect = e.target.getBoundingClientRect();
        dragStartX = e.clientX - rect.left - cropX;
        dragStartY = e.clientY - rect.top - cropY;
    }

    window.drag = function(e) {
        if (!isDragging) return;
        const rect = e.target.getBoundingClientRect();
        cropX = e.clientX - rect.left - dragStartX;
        cropY = e.clientY - rect.top - dragStartY;
        drawCropCanvas();
    }

    window.endDrag = function() {
        isDragging = false;
    }

    window.updateCropZoom = function() {
        cropScale = parseInt(document.getElementById('zoomSlider').value);
        drawCropCanvas();
    }

    window.closeFotoCropper = function() {
        document.getElementById('fotoCropperDialog').classList.remove('show');
        document.getElementById('profilFotoInput').value = '';
    }

    window.saveCroppedFoto = async function() {
        const canvas = document.getElementById('cropCanvas');
        const cropCanvas = document.createElement('canvas');
        cropCanvas.width = 200;
        cropCanvas.height = 200;
        const ctx = cropCanvas.getContext('2d');
        ctx.drawImage(canvas, 50, 50, 200, 200, 0, 0, 200, 200);
        
        const base64 = cropCanvas.toDataURL('image/jpeg', 0.9);
        
        try {
            const { error } = await supabaseClient
                .from('mitarbeiter')
                .update({ foto: base64 })
                .eq('id', currentUser.mitarbeiterId);
            
            if (error) throw error;
            
            const preview = document.getElementById('profilFotoPreview');
            preview.innerHTML = `<img src="${base64}" style="width: 100%; height: 100%; object-fit: cover;">`;
            document.getElementById('btnRemoveFoto').style.display = 'inline-block';
            
            updateHeaderAvatar();
            closeFotoCropper();
        } catch (error) {
            console.error('Error:', error);
            alert('‚ùå Fehler: ' + error.message);
        }
    }

    window.removeProfilFoto = async function() {
        if (!confirm('Foto wirklich entfernen?')) return;
        
        if (!currentUser.mitarbeiterId) {
            alert('‚ö†Ô∏è Kein Mitarbeiter-Eintrag gefunden');
            return;
        }
        
        try {
            const { error } = await supabaseClient
                .from('mitarbeiter')
                .update({ foto: null })
                .eq('id', currentUser.mitarbeiterId);
            
            if (error) throw error;
            
            const preview = document.getElementById('profilFotoPreview');
            preview.innerHTML = getInitials(currentUser.name);
            preview.style.background = 'var(--primary)';
            document.getElementById('btnRemoveFoto').style.display = 'none';
            
            updateHeaderAvatar();
        } catch (error) {
            console.error('Error:', error);
            alert('‚ùå Fehler: ' + error.message);
        }
    }

    async function updateHeaderAvatar() {
        try {
            const { data: mitarbeiter } = await supabaseClient
                .from('mitarbeiter')
                .select('foto')
                .ilike('vorname', currentUser.name.split(' ')[0])
                .ilike('nachname', currentUser.name.split(' ').slice(1).join(' '))
                .single();
            
            const avatar = document.getElementById('userAvatar');
            if (mitarbeiter?.foto) {
                avatar.innerHTML = `<img src="${mitarbeiter.foto}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            } else {
                avatar.textContent = getInitials(currentUser.name);
                avatar.style.background = '#4f46e5';
            }
        } catch (error) {
            console.error('Error updating avatar:', error);
        }
    }
    </script>
    
    <!-- Version Check -->
    <div id="versionInfo" style="position: fixed; bottom: 8px; right: 8px; font-size: 10px; color: #999; background: white; padding: 4px 8px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 9999;">
        v2026-02-13_11:20 (Responsive Design)
    </div>
</body>
</html>
